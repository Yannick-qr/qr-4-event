<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription √âv√©nement</title>
  <style>
/* ===== Base ===== */
*,
*::before,
*::after { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  background: #f5f6fa;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  color: #1f2937;
}

/* ===== Variables UI ===== */
:root{
  --bg: #f5f6fa;
  --card: #ffffff;
  --text: #1f2937;
  --muted: #6b7280;
  --primary: #007bff;
  --primary-dark:#0056b3;
  --ring: 0 0 0 3px rgba(0,123,255,.18);

  /* Largeur commune image + carte */
  --card-max: 680px;
  --card-side: 26px;
}

/* ===== Fond plein √©cran flout√© depuis #event-image ===== */
:root{ --event-bg-url: url("/static/img/placeholder.png"); }
body::before{
  content:"";
  position: fixed; inset: 0; z-index: -2;
  background-image: var(--event-bg-url);
  background-size: cover; background-position: center; background-repeat: no-repeat;
  filter: blur(14px); transform: scale(1.08);
}
body::after{
  content:"";
  position: fixed; inset: 0; z-index: -1;
  background:
    radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,.25), transparent 60%),
    linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.10) 30%, rgba(0,0,0,.25));
  pointer-events: none;
}

/* ===== Header fa√ßon banni√®re (m√™me largeur que .box) ===== */
.event-header {
  position: relative;
  width: 95%;
  max-width: var(--card-max);
  margin: 24px auto 10px;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 10px 24px rgba(0,0,0,.06);
}
.event-header img {
  width: 100%;
  height: clamp(190px, 28vw, 260px);
  display: block;
  object-fit: cover;
  border-radius: 16px;
}
/* D√©grad√© sombre sous le titre */
.event-header::after {
  content: "";
  position: absolute; inset: auto 0 0 0;
  height: 140px;
  background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
  border-radius: 0 0 16px 16px;
}
/* Titre superpos√© */
.event-header h2 {
  position: absolute;
  bottom: 18px; left: 22px;
  margin: 0;
  padding: 10px 14px;
  color: #fff;
  font-size: clamp(1.3rem, 3.6vw, 2rem);
  z-index: 2;
  text-shadow: 0 2px 6px rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
  border-radius: 10px;
}

/* ===== Carte principale (cadre blanc) ===== */
.box {
  width: 95%;
  max-width: var(--card-max);
  background: rgba(255,255,255,.96);
  margin: 10px auto 42px;
  padding: 28px var(--card-side) 30px;
  border-radius: 16px;
  border: 1px solid #eef2f7;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  transition: transform .2s;
}
.box:hover { transform: translateY(-3px); }

h3 { margin: 0 0 14px; color: var(--primary); text-align: center; font-weight: 700; letter-spacing: .2px; }
p { margin: 8px 0; }

/* S√©parateur design */
.box hr{
  margin: 25px 0;
  border: none; height: 2px;
  background: linear-gradient(90deg, var(--primary), #00c6ff);
  border-radius: 2px;
}

/* ===== Infos √©v√©nement ===== */
.event-details p {
  font-size: 16px;
  margin: 10px 0;
  color: #333;
  display: flex;
  align-items: center;
}
.event-details .icon {
  margin-right: 8px;
  font-size: 1.2rem;
  width: 22px; display:inline-flex; align-items:center; justify-content:center;
}

/* Description */
.about-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; color: #444; text-align: left; position: relative; }
.about-title::after{
  content:"";
  position:absolute; left:0; bottom:-6px; width:42px; height:3px;
  background: linear-gradient(90deg, var(--primary), #00c6ff);
  border-radius: 2px;
}
.description{
  margin: 10px 0 30px;
  background: #fafbff;
  border: 1px solid #eef2f7;
  padding: 12px 14px;
  border-radius: 10px;
  color: #4b5563;
  font-style: normal;
}

/* ===== Formulaire ===== */
#registerForm{
  display: grid;
  grid-template-columns: minmax(0,1fr) minmax(0,1fr); /* robuste, pas de d√©bordement */
  grid-auto-rows: auto;
  gap: 12px;
  margin-top: 8px;
}

/* Champs communs */
#registerForm input{
  display: block;
  width: 100%;
  margin: 0;
  padding: 12px 14px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  font-size: 1rem;
  background: #fff;
  transition: border-color .2s, box-shadow .2s, background .2s;
}
#registerForm input::placeholder{ color:#94a3b8; }
#registerForm input:focus{
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--ring);
  background: #ffffff;
}
/* √âtats simples */
#registerForm input:invalid:focus{ border-color:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.16); }
#registerForm input:valid:focus  { border-color:#10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.16); }

/* Placement pr√©cis pour √©viter tout chevauchement */
#first_name{ grid-column: 1; }
#last_name { grid-column: 2; }
#email     { grid-column: 1 / -1; } /* email sur toute la ligne */

/* ===== Bouton d'inscription (custom PayPal) ===== */
#custom-paypal-btn{
  width: 100%;
  max-width: 520px;
  background: linear-gradient(90deg, #007bff, #0056b3);
  color: white;
  border: none;
  padding: 14px 25px;
  border-radius: 30px;
  font-size: 1.1rem;
  cursor: pointer;
  font-weight: bold;
  transition: background .3s, transform .2s, box-shadow .2s;
  display: block;
  margin: 20px auto 0;
  position: relative;
  box-shadow: 0 8px 18px rgba(0,123,255,.25);
}
#custom-paypal-btn:hover {
  background: linear-gradient(90deg, #0056b3, #003f80);
  transform: scale(1.03);
  box-shadow: 0 10px 22px rgba(0,86,179,.28);
}
#custom-paypal-btn.loading { cursor: wait; opacity: .85; }
#custom-paypal-btn.loading::after {
  content: "";
  position: absolute; right: 15px; top: 50%;
  width: 16px; height: 16px;
  border: 2px solid white; border-top: 2px solid transparent;
  border-radius: 50%; transform: translateY(-50%);
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

#paypal-button-container{ margin-top: 14px; display:flex; justify-content:center; }
#cancel-container{ margin-top: 10px; }

/* ===== Messages ===== */
#message{ margin-top: 10px; }
.success{
  color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0;
  padding:10px 12px; border-radius:10px; font-weight:600; margin-top: 10px;
}
.error{
  color:#7f1d1d; background:#fee2e2; border:1px solid #fecaca;
  padding:10px 12px; border-radius:10px; font-weight:600; margin-top: 10px;
}

/* ===== Responsive ===== */
@media (max-width: 768px){
  .event-header { width: 94%; border-radius: 14px; }
  .event-header img{ height: 220px; border-radius: 14px; }
  .event-header h2 { font-size: 1.4rem; left: 14px; bottom: 10px; }

  .box{ width: 94%; padding: 22px 18px 24px; background: rgba(255,255,255,.98); }

  /* Grille 1 colonne sur mobile + spans corrects */
  #registerForm{
    grid-template-columns: 1fr;
    gap: 12px;
  }
  #first_name{ grid-column: 1; }
  #last_name { grid-column: 1; }
  #email     { grid-column: 1; }

  #custom-paypal-btn{ max-width: none; }
  .description{ padding: 10px 12px; }
}
</style>


</head>
<body>

  <!-- ‚úÖ Header -->
  <div class="event-header">
    <img id="event-image" src="/static/img/placeholder.png" alt="Image de l'√©v√©nement">
   
 <h2 id="event-title">Chargement...</h2>
  </div>

<!-- ‚úÖ Box infos am√©lior√©e -->
<div class="box">
<h3 class="about-title">√Ä propos de l‚Äô√©v√©nement</h3> <!-- ‚úÖ Nouveau titre -->
<p id="event-description" class="description"></p> <!-- ‚úÖ description restaur√©e -->
  <div class="event-details">
    <p><span class="icon">üìÖ</span> <b>Date :</b>&nbsp;<span id="event-date"></span></p>
    <p><span class="icon">üìç</span> <b>Lieu :</b>&nbsp;<span id="event-location"></span></p>
    <p><span class="icon">üí∂</span> <b>Prix :</b>&nbsp;<span id="event-price"></span> ‚Ç¨</p>
  </div>
  
  <!-- Carte affich√©e en permanence -->
<div id="map-container"
     style="width:95%;max-width:680px;height:320px;margin:0 auto 40px;
            border-radius:16px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.1);">
</div>


  <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="first_name" placeholder="Votre pr√©nom" required>
      <input type="text" id="last_name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <!-- ‚úÖ Ton bouton bleu -->
    <button id="custom-paypal-btn">M‚Äôinscrire</button>
    <div id="paypal-button-container"></div>
    <div id="cancel-container" style="text-align:center; margin-top:10px;"></div> <!-- ‚úÖ ICI -->
  </div>

<script>
  let eventId = new URLSearchParams(location.search).get("id");
  if (!eventId) {
    document.body.innerHTML = "<h2>‚ö†Ô∏è Aucun √©v√©nement s√©lectionn√©.</h2>";
  }

  const pick = (o, ...keys) => {
    for (const k of keys) if (o && o[k] != null && o[k] !== "") return o[k];
    return undefined;
  };


  // ‚úÖ Afficher la carte
  function showMap(place) {
    const mapDiv = document.getElementById("map-container");
    if (!mapDiv || !window.google || !google.maps) return;

    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: place }, (results, status) => {
      if (status === "OK" && results[0]) {
        const loc = results[0].geometry.location;
        const map = new google.maps.Map(mapDiv, {
          center: loc,
          zoom: 15
        });

  // ‚úÖ Nouveau Marker recommand√©
  new google.maps.marker.AdvancedMarkerElement({
    position: loc,
    map: map
      });
    }
  });
}  // ‚úÖ ferme bien la fonction
  
  async function loadEvent() {
    const message = document.getElementById("message");
    const setFatal = (txt) => {
      document.getElementById("event-title").textContent = "√âv√©nement";
      document.getElementById("event-description").textContent = "‚ùå Impossible de charger l‚Äô√©v√©nement.";
      if (message) message.innerHTML = `<p class="error">${txt}</p>`;
    };

    try {
      // --- Appel direct vers l'endpoint JSON ---
      const resEvent = await fetch(`/api/event/${encodeURIComponent(eventId)}`, {
        headers: { "Accept": "application/json" }
      });
      if (!resEvent.ok) { setFatal(`HTTP ${resEvent.status}`); return; }

      const dataEvent = await resEvent.json();
      const ev = dataEvent.event || dataEvent; // ‚Üê garder UNE SEULE FOIS

      // --- Remplissage UI ---
      const title  = pick(ev, "title", "name") || "√âv√©nement";
      const desc   = pick(ev, "description", "desc") || "Pas de description disponible.";
      const date   = pick(ev, "date", "event_date", "start_date") || "‚Äî";
      const place  = pick(ev, "location", "place", "city", "venue") || "‚Äî";
      const price  = pick(ev, "price", "amount", "price_eur") ?? 0;
      const imgUrl = pick(ev, "image_url", "image", "cover", "banner_url");

      document.getElementById("event-title").textContent = title;
      document.getElementById("event-description").innerHTML = desc;
      document.getElementById("event-date").textContent = date;
      document.getElementById("event-location").textContent = place;
      
      // ‚úÖ Afficher la carte d√®s que l‚Äôadresse est connue
      if (place && place !== "‚Äî") {
        const waitForGoogle = setInterval(() => {
          if (window.google && google.maps) {
            clearInterval(waitForGoogle);
            showMap(place);
          }
        }, 300);
      }
      
      document.getElementById("event-price").textContent = price;
      const img = document.getElementById("event-image");
      img.src = imgUrl || "/static/img/placeholder.png";
      img.onerror = () => { img.src = "/static/img/placeholder.png"; };

// ---- pousse l'URL de #event-image dans le fond flout√©
const setPageBg = (url) =>
  document.documentElement.style.setProperty('--event-bg-url', `url("${url}")`);

setPageBg(imgUrl || "/static/img/placeholder.png");  // imm√©diat
img.onload  = () => setPageBg(img.currentSrc || img.src); // s√ªret√© apr√®s chargement
img.onerror = () => setPageBg("/static/img/placeholder.png"); // fallback


      // üîí Cr√©dits (non bloquant)
      try {
        const rC = await fetch(`/api/license/credits?event_id=${encodeURIComponent(eventId)}`);
        if (rC.ok) {
          const credits = await rC.json();
          if (typeof credits?.remaining_participant_credits === "number" &&
              credits.remaining_participant_credits <= 0) {
            document.getElementById("custom-paypal-btn").outerHTML =
              "<p style='color:red;font-weight:bold;'>‚ùå Inscriptions closes (cr√©dits √©puis√©s)</p>";
            return;
          }
        }
      } catch {}

      if ((ev.participants_count ?? 0) >= (ev.max_participants ?? Infinity)) {
        document.getElementById("custom-paypal-btn").outerHTML =
          "<p style='color:red;font-weight:bold;'>‚ùå Inscriptions closes (√©v√©nement complet)</p>";
        return;
      }

      // üí≥ PayPal
      const res = await fetch(`/api/paypal-client-id?event_id=${encodeURIComponent(eventId)}`);
      const data = await res.json();
      if (!data.client_id) return;

      const script = document.createElement("script");
      script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
      document.head.appendChild(script);

      script.onload = () => {
        const customBtn = document.getElementById("custom-paypal-btn");
        const msg = document.getElementById("message");
        let paypalRendered = false;

        // reset si l'utilisateur modifie un champ
        ["first_name","last_name","email"].forEach(id => {
          const input = document.getElementById(id);
          if (input) input.addEventListener("input", () => { restoreBtn(); msg.innerHTML = ""; });
        });

        customBtn.addEventListener("click", () => {
          const firstName = document.getElementById("first_name").value.trim();
          const lastName  = document.getElementById("last_name").value.trim();
          const email     = document.getElementById("email").value.trim();

          if (!firstName || !lastName || !email) { msg.innerHTML = "<p class='error'>‚ö†Ô∏è Veuillez renseigner tous les champs.</p>"; return; }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { msg.innerHTML = "<p class='error'>‚ö†Ô∏è Email invalide</p>"; return; }
          if (paypalRendered) { msg.innerHTML = "<p class='error'>‚ö†Ô∏è Le bouton PayPal est d√©j√† actif.</p>"; return; }

          customBtn.classList.add("loading");
          customBtn.disabled = true;
          customBtn.textContent = "Chargement...";
          document.getElementById("paypal-button-container").innerHTML = "";

          paypal.Buttons({
            createOrder() {
              return fetch(`/event/${eventId}/pay`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ firstName, lastName, email })
              })
              .then(r => r.json())
              .then(order => {
                if (!order?.id) {
                  msg.innerHTML = "<p class='error'>‚ùå " + (order.message || "Impossible de cr√©er la commande PayPal") + "</p>";
                  restoreBtn();
                  throw new Error(order.message || "createOrder");
                }
                return order.id;
              })
              .catch(err => { console.error("‚ùå Erreur PayPal:", err); restoreBtn(); throw err; });
            },
            onApprove(data, actions) {
              return actions.order.capture().then(details => {
                const transactionId = details.id;
                const amount = details.purchase_units[0].amount.value;
                return fetch("/register_participant", {
                  method: "POST",
                  headers: { "Content-Type": "application/x-www-form-urlencoded" },
                  body: new URLSearchParams({
                    first_name: firstName,
                    last_name: lastName,
                    email,
                    event_id: eventId,
                    amount,
                    transaction_id: transactionId
                  })
                })
                .then(r => r.json())
                .then(res => {
                  msg.innerHTML = "<p class='" + (res.success ? "success" : "error") + "'>" + (res.message || res.error || "Erreur inconnue") + "</p>";
                  restoreBtn();
                  if (res.success) document.getElementById("registerForm").reset();
                })
                .catch(err => {
                  console.error("‚ùå Enregistrement:", err);
                  msg.innerHTML = "<p class='error'>‚ùå Paiement valid√© mais enregistrement impossible.</p>";
                  restoreBtn();
                });
              });
            },
            onError(err) { msg.innerHTML = "<p class='error'>‚ùå Erreur PayPal : " + err.message + "</p>"; restoreBtn(); },
            onCancel()   { msg.innerHTML = "<p class='success'>‚ÑπÔ∏è Vous avez annul√© le paiement.</p>"; restoreBtn(); }
          }).render("#paypal-button-container");

          // bouton Annuler
          document.getElementById("cancel-container").innerHTML =
            "<button id='cancel-btn' style='background:none;border:none;color:#ff4444;font-size:1.2rem;cursor:pointer;'>‚ùå Annuler</button>";
          document.getElementById("cancel-btn").addEventListener("click", () => {
            msg.innerHTML = "<p class='success'>‚ÑπÔ∏è Vous avez annul√© l‚Äôinscription.</p>";
            restoreBtn();
            document.getElementById("cancel-container").innerHTML = "";
          });

          paypalRendered = true;
          customBtn.style.display = "none";

          function restoreBtn() {
            customBtn.classList.remove("loading");
            customBtn.disabled = false;
            customBtn.textContent = "M‚Äôinscrire";
            customBtn.style.display = "block";
            paypalRendered = false;
            document.getElementById("paypal-button-container").innerHTML = "";
            document.getElementById("cancel-container").innerHTML = "";
          }
        });
      };
    } catch (e) {
      console.error(e);
      setFatal(String(e));
    }
  }

  loadEvent();
</script>

<script>
// Charger Google Maps dynamiquement avec la cl√© du backend
async function loadGoogleMaps() {
  try {
    const res = await fetch("/api/config/maps-key");
    const data = await res.json();
    if (!data.key) {
      console.error("‚ùå Pas de cl√© Google Maps");
      return;
    }

    const script = document.createElement("script");
    // ‚úÖ ajout de &loading=async
    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=places,marker&loading=async`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  } catch (err) {
    console.error("Erreur chargement Google Maps:", err);
  }
}

loadGoogleMaps();
</script>

</body>
</html>
