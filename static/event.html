<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription √âv√©nement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* ‚úÖ Header image fa√ßon banni√®re */
.event-header {
  position: relative;
  width: 100%;
  height: 250px;          /* ‚úÖ hauteur fixe (tu peux mettre 300px si tu veux plus grand) */
  overflow: hidden;
  border-radius: 0 0 10px 10px;
  background: #ddd;       /* ‚úÖ couleur placeholder tant que l‚Äôimage n‚Äôest pas l√† */
}

.event-header img {
  width: 100%;
  height: 100%;           /* ‚úÖ occupe toute la zone */
  object-fit: cover;      /* ‚úÖ recadrage sans d√©formation */
  display: block;
}


    /* ‚úÖ Overlay d√©grad√© */
    .event-header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 140px;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      border-radius: 0 0 12px 12px;
    }

    /* ‚úÖ Titre superpos√© */
    .event-header h2 {
      position: absolute;
      bottom: 20px;
      left: 25px;
      margin: 0;
      padding: 10px 15px;
      color: #fff;
      font-size: 2rem;
      z-index: 2;
      text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    /* ‚úÖ Box infos */
    .box {
      background: white;
      margin: 20px auto 40px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
    }

    h3 { margin-top: 0; color: #007bff; text-align: center; }
    p { margin: 8px 0; }

    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .success { color: green; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }

    /* üéØ Responsive */
    @media (max-width: 768px) {
      .event-header {
        max-width: 100%;
        border-radius: 0;
      }
      .box {
        width: 95%;
        padding: 20px;
      }
      .event-header h2 {
        font-size: 1.4rem;
        left: 15px;
        bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- ‚úÖ Header avec image -->
<div class="event-header">
  <img id="event-image" src="/static/img/placeholder.jpg" alt="Image de l'√©v√©nement">
  <h2 id="event-title">Chargement...</h2>
</div>

  <!-- ‚úÖ Box infos + inscription -->
  <div class="box">
    <p id="event-description"></p>
    <p><b>Date :</b> <span id="event-date"></span></p>
    <p><b>Lieu :</b> <span id="event-location"></span></p>
    <p><b>Prix :</b> <span id="event-price"></span> ‚Ç¨</p>
    <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <div id="paypal-button-container" style="margin-top:20px; text-align:center;"></div>
  </div>

  <script>
    let eventId = null;
    let eventPrice = 0;
    let eventTitle = "";

    const urlParams = new URLSearchParams(window.location.search);
    eventId = urlParams.get("id");

    if (!eventId) {
      document.body.innerHTML = "<h2>‚ö†Ô∏è Aucun √©v√©nement s√©lectionn√©.</h2>";
    }

    async function loadEvent() {
      const resEvent = await fetch(`/api/event/${eventId}`);
      const dataEvent = await resEvent.json();
      if (!dataEvent.success) {
        document.querySelector(".box").innerHTML = "<h2>‚ùå √âv√©nement introuvable</h2>";
        return;
      }
      const event = dataEvent.event;

      eventTitle = event.title;
      eventPrice = event.price;

      document.getElementById("event-title").textContent = event.title;
      document.getElementById("event-description").textContent = event.description || "Pas de description disponible.";
      document.getElementById("event-date").textContent = event.date;
      document.getElementById("event-location").textContent = event.location;
      document.getElementById("event-price").textContent = event.price;

// ‚úÖ Gestion stable de l‚Äôimage
const img = document.getElementById("event-image");

// Image par d√©faut (placeholder)
img.src = "/static/img/placeholder.jpg";

// Si une image est d√©finie pour l‚Äô√©v√©nement
if (event.image_url) {
  img.onload = () => {
    console.log("‚úÖ Image √©v√©nement charg√©e :", event.image_url);
  };
  img.onerror = () => {
    console.warn("‚ö†Ô∏è Erreur image, retour au placeholder.");
    img.src = "/static/img/placeholder.jpg";
  };
  img.src = event.image_url;
}


      // V√©rif cr√©dits
      const resCredits = await fetch(`/api/license/credits?event_id=${eventId}`);
      const credits = await resCredits.json();

      let complet = false;
      if (credits.remaining_participant_credits <= 0) {
        complet = true;
        document.getElementById("paypal-button-container").innerHTML =
          "<p style='color:red; font-weight:bold;'>‚ùå Inscriptions closes</p>";
      } else if (event.participants_count >= event.max_participants) {
        complet = true;
        document.getElementById("paypal-button-container").innerHTML =
          "<p style='color:red; font-weight:bold;'>‚ùå Inscriptions closes (√©v√©nement complet)</p>";
      }

      // PayPal
      if (!complet) {
        const res = await fetch(`/api/paypal-client-id?event_id=${eventId}`);
        const data = await res.json();
        if (data.client_id) {
          const script = document.createElement("script");
          script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
          script.onload = function () {
            paypal.Buttons({
              onClick: function(data, actions) {
                const name = document.getElementById("name").value.trim();
                const email = document.getElementById("email").value.trim();
                const messageDiv = document.getElementById("message");

                const emailValid = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);

                if (name === "" || email === "") {
                  messageDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Veuillez renseigner votre nom et votre email.</p>";
                  return actions.reject();
                }
                if (!emailValid) {
                  messageDiv.innerHTML = "<p class='error'>‚ùå Veuillez entrer une adresse email valide.</p>";
                  return actions.reject();
                }
                messageDiv.innerHTML = "";
                return actions.resolve();
              },

              createOrder: function(data, actions) {
                return fetch(`/event/${eventId}/pay`, { method: "POST" })
                  .then(res => res.json())
                  .then(order => {
                    if (!order.success) throw new Error(order.error || "Erreur backend");
                    return order.id;
                  });
              },

              onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                  const name = document.getElementById("name").value;
                  const email = document.getElementById("email").value;

                  const formData = new FormData();
                  formData.append("name", name);
                  formData.append("email", email);
                  formData.append("event_id", eventId);
                  formData.append("amount", event.price);
                  formData.append("transaction_id", details.id);

                  fetch("/register_participant", {
                    method: "POST",
                    body: formData
                  })
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      document.getElementById("message").innerHTML =
                        `<p class='success'>Merci ${name} ! Votre paiement a √©t√© valid√© ‚úÖ<br>
                        Une confirmation vous sera envoy√©e par email (${email}).</p>`;
                      document.getElementById("registerForm").reset();
                    } else {
                      document.getElementById("message").innerHTML =
                        `<p class='error'>‚ö†Ô∏è Erreur d'enregistrement : ${data.error}</p>`;
                    }
                  });
                });
              },

              onError: function(err) {
                console.error("Erreur PayPal:", err);
              }
            }).render('#paypal-button-container');
          };
          document.head.appendChild(script);
        }
      }
    }

    loadEvent();
  </script>
</body>
</html>
