<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription Événement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .event-header {
      position: relative;
      max-width: 900px;
      margin: 20px auto;
      max-height: 400px;
      overflow: hidden;
      border-radius: 12px;
    }
    .event-header img {
      width: 100%;
      display: block;
      object-fit: cover;
    }
    .event-header h2 {
      position: absolute;
      bottom: 20px;
      left: 25px;
      margin: 0;
      color: #fff;
      font-size: 2rem;
      text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .box {
      background: white;
      margin: 20px auto 40px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
    }

    h3 { margin-top: 0; color: #007bff; text-align: center; }
    .success { color: green; }
    .error { color: red; }

    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* ✅ Bouton personnalisé */
    #custom-paypal-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      display: block;
      margin: 20px auto 0;
      position: relative;
    }
    #custom-paypal-btn:hover {
      background: #0056b3;
    }
    #custom-paypal-btn.loading {
      cursor: wait;
      opacity: 0.8;
    }
    #custom-paypal-btn.loading::after {
      content: "";
      position: absolute;
      right: 15px;
      top: 50%;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top: 2px solid transparent;
      border-radius: 50%;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- ✅ Header -->
  <div class="event-header">
    <img id="event-image" src="/static/img/placeholder.png" alt="Image de l'événement">
    <h2 id="event-title">Chargement...</h2>
  </div>

  <!-- ✅ Box infos -->
  <div class="box">
    <p id="event-description"></p>
    <p><b>Date :</b> <span id="event-date"></span></p>
    <p><b>Lieu :</b> <span id="event-location"></span></p>
    <p><b>Prix :</b> <span id="event-price"></span> €</p>
    <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <!-- ✅ Ton bouton bleu -->
    <button id="custom-paypal-btn">M’inscrire</button>
  </div>

<script>
  let eventId = null;
  let eventPrice = 0;
  let eventTitle = "";

  const urlParams = new URLSearchParams(window.location.search);
  eventId = urlParams.get("id");

  if (!eventId) {
    document.body.innerHTML = "<h2>⚠️ Aucun événement sélectionné.</h2>";
  }

  async function loadEvent() {
    const resEvent = await fetch(`/api/event/${eventId}`);
    const dataEvent = await resEvent.json();
    if (!dataEvent.success) {
      document.querySelector(".box").innerHTML = "<h2>❌ Événement introuvable</h2>";
      return;
    }
    const event = dataEvent.event;
    eventTitle = event.title;
    eventPrice = event.price;

    document.getElementById("event-title").textContent = event.title;
    document.getElementById("event-description").textContent = event.description || "Pas de description disponible.";
    document.getElementById("event-date").textContent = event.date;
    document.getElementById("event-location").textContent = event.location;
    document.getElementById("event-price").textContent = event.price;

    // ✅ Image
    const img = document.getElementById("event-image");
    img.src = event.image_url || "/static/img/placeholder.png";

    // Vérif crédits
    const resCredits = await fetch(`/api/license/credits?event_id=${eventId}`);
    const credits = await resCredits.json();

    if (credits.remaining_participant_credits <= 0) {
      document.getElementById("custom-paypal-btn").outerHTML =
        "<p style='color:red; font-weight:bold;'>❌ Inscriptions closes (crédits épuisés)</p>";
      return;
    } else if (event.participants_count >= event.max_participants) {
      document.getElementById("custom-paypal-btn").outerHTML =
        "<p style='color:red; font-weight:bold;'>❌ Inscriptions closes (événement complet)</p>";
      return;
    }

    // Charger PayPal SDK
    const res = await fetch(`/api/paypal-client-id?event_id=${eventId}`);
    const data = await res.json();
    if (!data.client_id) return;

    const script = document.createElement("script");
    script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
    document.head.appendChild(script);

    script.onload = () => {
      const customBtn = document.getElementById("custom-paypal-btn");
      const msg = document.getElementById("message");

      customBtn.addEventListener("click", () => {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        if (!name || !email) {
          msg.innerHTML = "<p class='error'>⚠️ Veuillez renseigner vos infos.</p>";
          return;
        }

        customBtn.classList.add("loading");
        customBtn.disabled = true;
        customBtn.textContent = "Chargement...";

        // ✅ Ouvre directement le pop-up PayPal
        paypal.Buttons({
          createOrder: function(data, actions) {
            return fetch(`/event/${eventId}/pay`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email })
            })
            .then(r => r.json())
            .then(order => {
              if (!order || !order.id) {
                msg.innerHTML = "<p class='error'>❌ " + (order.message || "Impossible de créer la commande PayPal") + "</p>";
                restoreBtn();
                throw new Error(order.message || "Impossible de créer la commande PayPal");
              }
              return order.id;
            })
            .catch(err => {
              console.error("❌ Erreur PayPal:", err);
              restoreBtn();
              throw err;
            });
          },

          onApprove: function(data, actions) {
            return actions.order.capture().then(details => {
              const transactionId = details.id;
              const amount = details.purchase_units[0].amount.value;

              fetch("/register_participant", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                  name: name,
                  email: email,
                  event_id: eventId,
                  amount: amount,
                  transaction_id: transactionId
                })
              })
              .then(r => r.json())
              .then(res => {
                // ✅ Affiche toujours res.message (succès ou erreur)
                msg.innerHTML = "<p class='" + (res.success ? "success" : "error") + "'>" + (res.message || res.error || "Erreur inconnue") + "</p>";
                restoreBtn();
                if (res.success) document.getElementById("registerForm").reset();
              })
              .catch(err => {
                console.error("❌ Erreur enregistrement participant:", err);
                msg.innerHTML = "<p class='error'>❌ Paiement validé mais impossible d’enregistrer ton inscription.</p>";
                restoreBtn();
              });
            });
          },
          onError: function(err) {
            msg.innerHTML = "<p class='error'>❌ Erreur PayPal : " + err.message + "</p>";
            restoreBtn();
          },
          onCancel: function() {
            msg.innerHTML = "<p class='success'>ℹ️ Vous avez annulé le paiement.</p>";
            restoreBtn();
          }
        }).render("body");
      });

      function restoreBtn() {
        customBtn.classList.remove("loading");
        customBtn.disabled = false;
        customBtn.textContent = "M’inscrire";
      }
    };
  }

  loadEvent();
</script>

</body>
</html>
