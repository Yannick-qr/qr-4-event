<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription √âv√©nement</title>
  <style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6fa;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

/* üé® Header fa√ßon banni√®re */
.event-header {
  position: relative;
  max-width: 900px;
  margin: 20px auto;
  max-height: 400px;
  overflow: hidden;
  border-radius: 12px;
}
.event-header img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
  border-radius: 12px;
}
/* ‚úÖ D√©grad√© sombre sous le titre */
.event-header::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 140px;
  background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
  border-radius: 0 0 12px 12px;
}
/* ‚úÖ Titre superpos√© */
.event-header h2 {
  position: absolute;
  bottom: 20px;
  left: 25px;
  margin: 0;
  padding: 10px 15px;
  color: #fff;
  font-size: 2rem;
  z-index: 2;
  text-shadow: 0 2px 6px rgba(0,0,0,0.5);
}

/* üóÇÔ∏è Box infos */
.box {
  background: white;
  margin: 20px auto 40px auto;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
}

h3 { margin-top: 0; color: #007bff; text-align: center; }
p { margin: 8px 0; }

.success { color: green; margin-top: 10px; }
.error { color: red; margin-top: 10px; }

input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 6px;
}

/* üéØ Bouton bleu personnalis√© */
#custom-paypal-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s;
  display: block;
  margin: 20px auto 0;
  position: relative;
}
#custom-paypal-btn:hover {
  background: #0056b3;
}
#custom-paypal-btn.loading {
  cursor: wait;
  opacity: 0.8;
}
#custom-paypal-btn.loading::after {
  content: "";
  position: absolute;
  right: 15px;
  top: 50%;
  width: 16px;
  height: 16px;
  border: 2px solid white;
  border-top: 2px solid transparent;
  border-radius: 50%;
  transform: translateY(-50%);
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  0% { transform: translateY(-50%) rotate(0deg); }
  100% { transform: translateY(-50%) rotate(360deg); }
}

/* üì± Responsive */
@media (max-width: 768px) {
  .event-header {
    max-width: 100%;
    border-radius: 0;
  }
  .box {
    width: 95%;
    padding: 20px;
  }
  .event-header h2 {
    font-size: 1.4rem;
    left: 15px;
    bottom: 10px;
  }
}
/* üì¶ Carte principale */
.box {
  background: white;
  margin: 20px auto 40px auto;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  width: 100%;
  max-width: 600px;
  transition: transform 0.2s;
}
.box:hover {
  transform: translateY(-3px);
}

/* üìÖ Infos √©v√©nement */
.event-details p {
  font-size: 16px;
  margin: 10px 0;
  color: #333;
  display: flex;
  align-items: center;
}
.event-details .icon {
  margin-right: 8px;
  font-size: 1.2rem;
}

/* üìù Description */
.description {
  margin-top: 10px;
  font-style: italic;
  color: #666;
}

/* üéØ Bouton inscription */
#custom-paypal-btn {
  background: linear-gradient(90deg, #007bff, #0056b3);
  color: white;
  border: none;
  padding: 14px 25px;
  border-radius: 30px;
  font-size: 1.1rem;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s, transform 0.2s;
  display: block;
  margin: 20px auto 0;
  position: relative;
}
#custom-paypal-btn:hover {
  background: linear-gradient(90deg, #0056b3, #003f80);
  transform: scale(1.05);
}

/* ‚úÖ Messages succ√®s/erreur */
.success { color: green; margin-top: 10px; font-weight: bold; }
.error { color: red; margin-top: 10px; font-weight: bold; }

  </style>
</head>
<body>

  <!-- ‚úÖ Header -->
  <div class="event-header">
    <img id="event-image" src="/static/img/placeholder.png" alt="Image de l'√©v√©nement">
    <h2 id="event-title">Chargement...</h2>
  </div>

<!-- ‚úÖ Box infos am√©lior√©e -->
<div class="box">
  <div class="event-details">
    <p><span class="icon">üìÖ</span> <b>Date :</b> <span id="event-date"></span></p>
    <p><span class="icon">üìç</span> <b>Lieu :</b> <span id="event-location"></span></p>
    <p><span class="icon">üí∂</span> <b>Prix :</b> <span id="event-price"></span> ‚Ç¨</p>
  </div>

  <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <!-- ‚úÖ Ton bouton bleu -->
    <button id="custom-paypal-btn">M‚Äôinscrire</button>
    <div id="paypal-button-container"></div>
    <div id="cancel-container" style="text-align:center; margin-top:10px;"></div> <!-- ‚úÖ ICI -->
  </div>

<script>
  let eventId = null;
  let eventPrice = 0;
  let eventTitle = "";
  let paypalRendered = false; // ‚úÖ emp√™che de recr√©er le bouton √† chaque clic

  // ‚úÖ Ajoute la fonction ici
  function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  const urlParams = new URLSearchParams(window.location.search);
  eventId = urlParams.get("id");

  if (!eventId) {
    document.body.innerHTML = "<h2>‚ö†Ô∏è Aucun √©v√©nement s√©lectionn√©.</h2>";
  }

  async function loadEvent() {
    const resEvent = await fetch(`/api/event/${eventId}`);
    const dataEvent = await resEvent.json();
    if (!dataEvent.success) {
      document.querySelector(".box").innerHTML = "<h2>‚ùå √âv√©nement introuvable</h2>";
      return;
    }
    const event = dataEvent.event;
    eventTitle = event.title;
    eventPrice = event.price;

    document.getElementById("event-title").textContent = event.title;
    document.getElementById("event-description").textContent = event.description || "Pas de description disponible.";
    document.getElementById("event-date").textContent = event.date;
    document.getElementById("event-location").textContent = event.location;
    document.getElementById("event-price").textContent = event.price;

    // ‚úÖ Image
    const img = document.getElementById("event-image");
    img.src = event.image_url || "/static/img/placeholder.png";

    // V√©rif cr√©dits
    const resCredits = await fetch(`/api/license/credits?event_id=${eventId}`);
    const credits = await resCredits.json();

    if (credits.remaining_participant_credits <= 0) {
      document.getElementById("custom-paypal-btn").outerHTML =
        "<p style='color:red; font-weight:bold;'>‚ùå Inscriptions closes (cr√©dits √©puis√©s)</p>";
      return;
    } else if (event.participants_count >= event.max_participants) {
      document.getElementById("custom-paypal-btn").outerHTML =
        "<p style='color:red; font-weight:bold;'>‚ùå Inscriptions closes (√©v√©nement complet)</p>";
      return;
    }

    // Charger PayPal SDK
    const res = await fetch(`/api/paypal-client-id?event_id=${eventId}`);
    const data = await res.json();
    if (!data.client_id) return;

    const script = document.createElement("script");
    script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
    document.head.appendChild(script);

    script.onload = () => {
      const customBtn = document.getElementById("custom-paypal-btn");
      const msg = document.getElementById("message");

// ‚úÖ Si l‚Äôutilisateur modifie ses infos ‚Üí on reset PayPal
document.getElementById("name").addEventListener("input", () => {
  restoreBtn();
});
document.getElementById("email").addEventListener("input", () => {
  restoreBtn();
});

customBtn.addEventListener("click", () => {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!name || !email) {
    msg.innerHTML = "<p class='error'>‚ö†Ô∏è Veuillez renseigner vos infos.</p>";
    return;
  }
  if (!isValidEmail(email)) {
    msg.innerHTML = "<p class='error'>‚ö†Ô∏è Email invalide</p>";
    return;
  }

  // ‚úÖ Si PayPal d√©j√† affich√© ‚Üí ne rien faire
  if (paypalRendered) {
    msg.innerHTML = "<p class='error'>‚ö†Ô∏è Le bouton PayPal est d√©j√† actif.</p>";
    return;
  }

  customBtn.classList.add("loading");
  customBtn.disabled = true;
  customBtn.textContent = "Chargement...";

  // ‚úÖ Vider le conteneur avant de cr√©er un nouveau bouton
  document.getElementById("paypal-button-container").innerHTML = "";

        // ‚úÖ Ouvre directement le pop-up PayPal
        paypal.Buttons({
          createOrder: function(data, actions) {
            return fetch(`/event/${eventId}/pay`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email })
            })
            .then(r => r.json())
            .then(order => {
              if (!order || !order.id) {
                msg.innerHTML = "<p class='error'>‚ùå " + (order.message || "Impossible de cr√©er la commande PayPal") + "</p>";
                restoreBtn();
                throw new Error(order.message || "Impossible de cr√©er la commande PayPal");
              }
              return order.id;
            })
            .catch(err => {
              console.error("‚ùå Erreur PayPal:", err);
              restoreBtn();
              throw err;
            });
          },

          onApprove: function(data, actions) {
            return actions.order.capture().then(details => {
              const transactionId = details.id;
              const amount = details.purchase_units[0].amount.value;

              fetch("/register_participant", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                  name: name,
                  email: email,
                  event_id: eventId,
                  amount: amount,
                  transaction_id: transactionId
                })
              })
              .then(r => r.json())
              .then(res => {
                // ‚úÖ Affiche toujours res.message (succ√®s ou erreur)
                msg.innerHTML = "<p class='" + (res.success ? "success" : "error") + "'>" + (res.message || res.error || "Erreur inconnue") + "</p>";
                restoreBtn();
                if (res.success) document.getElementById("registerForm").reset();
              })
              .catch(err => {
                console.error("‚ùå Erreur enregistrement participant:", err);
                msg.innerHTML = "<p class='error'>‚ùå Paiement valid√© mais impossible d‚Äôenregistrer ton inscription.</p>";
                restoreBtn();
              });
            });
          },
          onError: function(err) {
            msg.innerHTML = "<p class='error'>‚ùå Erreur PayPal : " + err.message + "</p>";
            restoreBtn();
          },
          onCancel: function() {
            msg.innerHTML = "<p class='success'>‚ÑπÔ∏è Vous avez annul√© le paiement.</p>";
            restoreBtn();
          }
        }).render("#paypal-button-container");

// ‚úÖ Ajoute la croix Annuler (juste apr√®s render)
document.getElementById("cancel-container").innerHTML =
  "<button id='cancel-btn' style='background:none; border:none; color:#ff4444; font-size:1.2rem; cursor:pointer;'>‚ùå Annuler</button>";

document.getElementById("cancel-btn").addEventListener("click", () => {
  msg.innerHTML = "<p class='success'>‚ÑπÔ∏è Vous avez annul√© l‚Äôinscription.</p>";
  restoreBtn();
  document.getElementById("cancel-container").innerHTML = ""; // vide la croix
});

  // ‚úÖ On marque que PayPal est d√©j√† affich√©
  paypalRendered = true;

  // ‚úÖ Cacher le bouton bleu (facultatif)
  customBtn.style.display = "none";
});

      function restoreBtn() {
        customBtn.classList.remove("loading");
        customBtn.disabled = false;
        customBtn.textContent = "M‚Äôinscrire";
        customBtn.style.display = "block";
        paypalRendered = false;
        document.getElementById("paypal-button-container").innerHTML = "";
        document.getElementById("cancel-container").innerHTML = ""; // ‚úÖ supprime la croix
      }
    };
  }

  loadEvent();
</script>

</body>
</html>
