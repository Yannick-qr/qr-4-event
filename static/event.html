<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription Événement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .event-header {
      position: relative;
      max-width: 900px;
      margin: 20px auto;
      max-height: 400px;
      overflow: hidden;
      border-radius: 12px;
    }
    .event-header img {
      width: 100%;
      display: block;
      object-fit: cover;
    }
    .event-header h2 {
      position: absolute;
      bottom: 20px;
      left: 25px;
      margin: 0;
      color: #fff;
      font-size: 2rem;
      text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .box {
      background: white;
      margin: 20px auto 40px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
    }

    h3 { margin-top: 0; color: #007bff; text-align: center; }
    .success { color: green; }
    .error { color: red; }

    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* ✅ Bouton personnalisé */
    #custom-paypal-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      display: block;
      margin: 20px auto 0;
      position: relative;
    }
    #custom-paypal-btn:hover {
      background: #0056b3;
    }
    #custom-paypal-btn.loading {
      cursor: wait;
      opacity: 0.8;
    }
    #custom-paypal-btn.loading::after {
      content: "";
      position: absolute;
      right: 15px;
      top: 50%;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top: 2px solid transparent;
      border-radius: 50%;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- ✅ Header -->
  <div class="event-header">
    <img id="event-image" src="/static/img/placeholder.png" alt="Image de l'événement">
    <h2 id="event-title">Chargement...</h2>
  </div>

  <!-- ✅ Box infos -->
  <div class="box">
    <p id="event-description"></p>
    <p><b>Date :</b> <span id="event-date"></span></p>
    <p><b>Lieu :</b> <span id="event-location"></span></p>
    <p><b>Prix :</b> <span id="event-price"></span> €</p>
    <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <button id="custom-paypal-btn">M’inscrire</button>
  </div>

  <script>
    let eventId = null;
    let eventPrice = 0;
    let eventTitle = "";

    const urlParams = new URLSearchParams(window.location.search);
    eventId = urlParams.get("id");

    if (!eventId) {
      document.body.innerHTML = "<h2>⚠️ Aucun événement sélectionné.</h2>";
    }

    async function loadEvent() {
      const resEvent = await fetch(`/api/event/${eventId}`);
      const dataEvent = await resEvent.json();
      if (!dataEvent.success) {
        document.querySelector(".box").innerHTML = "<h2>❌ Événement introuvable</h2>";
        return;
      }
      const event = dataEvent.event;
      eventTitle = event.title;
      eventPrice = event.price;

      document.getElementById("event-title").textContent = event.title;
      document.getElementById("event-description").textContent = event.description || "Pas de description disponible.";
      document.getElementById("event-date").textContent = event.date;
      document.getElementById("event-location").textContent = event.location;
      document.getElementById("event-price").textContent = event.price;

      // ✅ Charger PayPal SDK
      const res = await fetch(`/api/paypal-client-id?event_id=${eventId}`);
      const data = await res.json();
      if (!data.client_id) return;

      const script = document.createElement("script");
      script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
      document.head.appendChild(script);

      script.onload = () => {
        const customBtn = document.getElementById("custom-paypal-btn");
        customBtn.addEventListener("click", async () => {
          const name = document.getElementById("name").value.trim();
          const email = document.getElementById("email").value.trim();
          const msg = document.getElementById("message");

          const emailValid = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);
if (!name || !email) {
  msg.innerHTML = "<p class='error'>⚠️ Veuillez renseigner votre nom et votre email.</p>";
  return;
}
if (!emailValid) {
  msg.innerHTML = "<p class='error'>❌ Adresse email invalide.</p>";
  return;
}

// ✅ Si valide → on efface les erreurs
msg.innerHTML = "";


          // ✅ Activer loader
          customBtn.classList.add("loading");
          customBtn.textContent = "Chargement...";

          try {
            const order = await fetch(`/event/${eventId}/pay`, { method: "POST" })
              .then(r => r.json());
            if (!order.success) throw new Error(order.error || "Erreur backend");

            const paypalOrder = await paypal.Orders.create({ purchase_units: [{ amount: { value: event.price } }] });
            const approval = await paypal.Orders.capture(order.id);

            // ✅ Enregistrer participant
            const formData = new FormData();
            formData.append("name", name);
            formData.append("email", email);
            formData.append("event_id", eventId);
            formData.append("amount", event.price);
            formData.append("transaction_id", approval.id);

            const save = await fetch("/register_participant", { method: "POST", body: formData }).then(r => r.json());

            if (save.success) {
              msg.innerHTML = `<p class='success'>Merci ${name} ! Paiement validé ✅<br>
                Confirmation envoyée à ${email}.</p>`;
              document.getElementById("registerForm").reset();
            } else {
              msg.innerHTML = `<p class='error'>⚠️ Erreur d'enregistrement : ${save.error}</p>`;
            }
          } catch (err) {
            console.error("Erreur PayPal:", err);
            msg.innerHTML = "<p class='error'>❌ Erreur avec PayPal</p>";
          } finally {
            // ✅ Désactiver loader
            customBtn.classList.remove("loading");
            customBtn.textContent = "M’inscrire";
          }
        });

        // ✅ Efface l’erreur dès qu’on modifie un champ
        document.getElementById("name").addEventListener("input", () => {
          document.getElementById("message").innerHTML = "";
        });
        document.getElementById("email").addEventListener("input", () => {
          document.getElementById("message").innerHTML = "";
        });
      };
    }

    loadEvent();
  </script>
</body>
</html>
