<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription √âv√©nement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* ‚úÖ Header image fa√ßon banni√®re */
    .event-header {
      position: relative;
      max-width: 900px;
      margin: 20px auto;
      height: auto;
      max-height: 400px;
      overflow: hidden;
      border-radius: 12px;
    }
    .event-header img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
      border-radius: 12px;
    }
    .event-header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 140px;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      border-radius: 0 0 12px 12px;
    }
    .event-header h2 {
      position: absolute;
      bottom: 20px;
      left: 25px;
      margin: 0;
      padding: 10px 15px;
      color: #fff;
      font-size: 2rem;
      z-index: 2;
      text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    /* ‚úÖ Box infos */
    .box {
      background: white;
      margin: 20px auto 40px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
    }

    h3 { margin-top: 0; color: #007bff; text-align: center; }
    p { margin: 8px 0; }

    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .success { color: green; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }

    /* ‚úÖ Bouton personnalis√© */
    #custom-paypal-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      display: block;
      margin: 20px auto 0;
      position: relative;
    }
    #custom-paypal-btn:hover {
      background: #0056b3;
    }
    #custom-paypal-btn.loading {
      cursor: wait;
      opacity: 0.8;
    }
    /* ‚úÖ Spinner dans le bouton */
    #custom-paypal-btn.loading::after {
      content: "";
      position: absolute;
      right: 15px;
      top: 50%;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top: 2px solid transparent;
      border-radius: 50%;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }

    /* üéØ Responsive */
    @media (max-width: 768px) {
      .event-header {
        max-width: 100%;
        border-radius: 0;
      }
      .box {
        width: 95%;
        padding: 20px;
      }
      .event-header h2 {
        font-size: 1.4rem;
        left: 15px;
        bottom: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- ‚úÖ Header avec image -->
  <div class="event-header">
    <img id="event-image" src="/static/img/placeholder.jpg" alt="Image de l'√©v√©nement">
    <h2 id="event-title">Chargement...</h2>
  </div>

  <!-- ‚úÖ Box infos + inscription -->
  <div class="box">
    <p id="event-description"></p>
    <p><b>Date :</b> <span id="event-date"></span></p>
    <p><b>Lieu :</b> <span id="event-location"></span></p>
    <p><b>Prix :</b> <span id="event-price"></span> ‚Ç¨</p>
    <hr>

    <h3>Inscription</h3>
    <div id="message"></div>
    <form id="registerForm">
      <input type="text" id="name" placeholder="Votre nom" required>
      <input type="email" id="email" placeholder="Votre email" required>
    </form>

    <!-- ‚úÖ Nouveau bouton bleu -->
    <button id="custom-paypal-btn">M‚Äôinscrire</button>

    <!-- ‚úÖ Bouton PayPal cach√© -->
    <div id="paypal-hidden-btn" style="display:none;"></div>
  </div>

  <script>
    let eventId = null;
    let eventPrice = 0;
    let eventTitle = "";

    const urlParams = new URLSearchParams(window.location.search);
    eventId = urlParams.get("id");

    if (!eventId) {
      document.body.innerHTML = "<h2>‚ö†Ô∏è Aucun √©v√©nement s√©lectionn√©.</h2>";
    }

    async function loadEvent() {
      const resEvent = await fetch(`/api/event/${eventId}`);
      const dataEvent = await resEvent.json();
      if (!dataEvent.success) {
        document.querySelector(".box").innerHTML = "<h2>‚ùå √âv√©nement introuvable</h2>";
        return;
      }
      const event = dataEvent.event;

      eventTitle = event.title;
      eventPrice = event.price;

      document.getElementById("event-title").textContent = event.title;
      document.getElementById("event-description").textContent = event.description || "Pas de description disponible.";
      document.getElementById("event-date").textContent = event.date;
      document.getElementById("event-location").textContent = event.location;
      document.getElementById("event-price").textContent = event.price;

      // ‚úÖ Gestion image
      const img = document.getElementById("event-image");
      img.src = "/static/img/placeholder.png";
      if (event.image_url) {
        img.onload = () => console.log("‚úÖ Image √©v√©nement charg√©e :", event.image_url);
        img.onerror = () => { img.src = "/static/img/placeholder.png"; };
        img.src = event.image_url;
      }

      // V√©rif cr√©dits
      const resCredits = await fetch(`/api/license/credits?event_id=${eventId}`);
      const credits = await resCredits.json();

      let complet = false;
      if (credits.remaining_participant_credits <= 0 || event.participants_count >= event.max_participants) {
        complet = true;
        document.getElementById("custom-paypal-btn").outerHTML =
          "<p style='color:red; font-weight:bold;'>‚ùå Inscriptions closes</p>";
      }

      // PayPal
      if (!complet) {
        const res = await fetch(`/api/paypal-client-id?event_id=${eventId}`);
        const data = await res.json();
        if (data.client_id) {
          const script = document.createElement("script");
          script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
          script.onload = function () {
            paypal.Buttons({
              onClick: function(data, actions) {
                const name = document.getElementById("name").value.trim();
                const email = document.getElementById("email").value.trim();
                const messageDiv = document.getElementById("message");

                const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

                if (name === "" || email === "") {
                  messageDiv.innerHTML = "<p class='error'>‚ö†Ô∏è Veuillez renseigner votre nom et votre email.</p>";
                  return actions.reject();
                }
                if (!emailValid) {
                  messageDiv.innerHTML = "<p class='error'>‚ùå Veuillez entrer une adresse email valide.</p>";
                  return actions.reject();
                }

                messageDiv.innerHTML = "";
                return actions.resolve();
              },

              createOrder: function(data, actions) {
                return fetch(`/event/${eventId}/pay`, { method: "POST" })
                  .then(res => res.json())
                  .then(order => {
                    if (!order.success) throw new Error(order.error || "Erreur backend");
                    return order.id;
                  });
              },

              onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                  const name = document.getElementById("name").value;
                  const email = document.getElementById("email").value;

                  const formData = new FormData();
                  formData.append("name", name);
                  formData.append("email", email);
                  formData.append("event_id", eventId);
                  formData.append("amount", event.price);
                  formData.append("transaction_id", details.id);

                  fetch("/register_participant", {
                    method: "POST",
                    body: formData
                  })
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      document.getElementById("message").innerHTML =
                        `<p class='success'>Merci ${name} ! Votre paiement a √©t√© valid√© ‚úÖ<br>
                        Une confirmation vous sera envoy√©e par email (${email}).</p>`;
                      document.getElementById("registerForm").reset();
                    } else {
                      document.getElementById("message").innerHTML =
                        `<p class='error'>‚ö†Ô∏è Erreur d'enregistrement : ${data.error}</p>`;
                    }
                  });
                });
              },

              onError: function(err) {
                console.error("Erreur PayPal:", err);
              }
            }).render('#paypal-hidden-btn');
          };
          document.head.appendChild(script);
        }

        // ‚úÖ Connecte bouton personnalis√© -> PayPal cach√© avec loader
        const customBtn = document.getElementById("custom-paypal-btn");
        customBtn.addEventListener("click", () => {
          const iframe = document.querySelector("#paypal-hidden-btn iframe");
          if (iframe) {
            // Ajoute le loader
            customBtn.classList.add("loading");
            customBtn.textContent = "Chargement...";
            iframe.contentWindow.focus();
            iframe.click();
            // Retire loader apr√®s 2s (le temps que PayPal ouvre sa pop-up)
            setTimeout(() => {
              customBtn.classList.remove("loading");
              customBtn.textContent = "M‚Äôinscrire";
            }, 2000);
          }
        });
      }
    }

    loadEvent();
  </script>
</body>
</html>
