<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan Event - Check-in</title>
  <style>
    /* ===== Base & Background ===== */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: url("https://luqmxczcojngdjwjaeod.supabase.co/storage/v1/object/public/event-images/login.webp")
                 center/cover no-repeat fixed;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0; padding: 20px;
    }

    :root { --field-width: 94%; }
    *, *::before, *::after { box-sizing: border-box; }

    /* ===== Card ===== */
    .card {
      width: 100%; max-width: 980px;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
      animation: fadeIn .6s ease-in-out;
      overflow: hidden;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

    .card-header {
      display:flex; align-items:center; gap:12px;
      padding:16px 20px; border-bottom:1px solid #eee;
    }
    .card-header img { width:42px; height:42px; object-fit:contain }
    .card-header h1 { margin:0; font-size:1.25rem; color:#2c3e50 }
    .subtitle { color:#566573; font-weight:400; font-size:.95em }

    .card-body {
      display:grid; gap:18px;
      grid-template-columns: 1.05fr .95fr;
      padding:18px;
    }
    @media (max-width: 900px){
      .card-body { grid-template-columns: 1fr; }
    }

    /* ===== Panel gauche (vid√©o + overlay + menu) ===== */
    .video-wrap {
      background:#fff; border-radius:14px; padding:12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    #reader {
      position: relative;
      border-radius:12px; overflow:hidden;
      background:#000;
    }
    .qr-overlay {
      pointer-events:none; position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
    }
    .qr-box {
      position:relative; width:80%; max-width:520px; aspect-ratio:1 / 1; border-radius:16px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.9);
    }
    .qr-corner { position:absolute; width:34px; height:34px; border:4px solid #00b894; }
    .qr-corner.tl { top:-2px; left:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px }
    .qr-corner.tr { top:-2px; right:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px }
    .qr-corner.bl { bottom:-2px; left:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px }
    .qr-corner.br { bottom:-2px; right:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px }

    .controls {
      margin-top:12px; display:grid; gap:10px;
      grid-template-columns: 1fr 1fr; align-items:end;
    }
    @media (max-width: 520px){
      .controls { grid-template-columns: 1fr; }
    }
    .control-group {
      background:#f7f9fb; border:1px solid #eef2f5; border-radius:12px; padding:10px;
    }
    .control-group h4 { margin:0 0 8px; font-size:.95rem; color:#2c3e50 }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row:last-child{ margin-bottom:0 }
    select, input[type="number"], input[type="text"] {
      width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:10px; font-size:.95em; background:#fff;
    }
    input[type="range"] { width:100% }

    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      font-weight:700; cursor:pointer; transition:transform .2s, box-shadow .2s;
      background:linear-gradient(135deg,#007bff,#3498db,#e91e63); background-size:200% 200%; color:#fff;
      animation: gradientMove 5s ease infinite; text-align:center;
    }
    @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .btn:hover { transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.15) }
    .btn:disabled { opacity:.6; cursor:not-allowed; box-shadow:none; transform:none }
    .btn-outline {
      background:#fff; color:#2c3e50; border:1px solid #cfd9e3; animation:none; font-weight:600;
    }

    .chip {
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      background:#eef6ff; color:#1f5fbf; border-radius:999px; font-size:.85rem; font-weight:600;
    }

    /* ===== Panel droite (infos + historique) ===== */
    .panel { display:grid; gap:14px; }
    .box {
      background:#fff; border-radius:14px; padding:14px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    .box h3 { margin:0 0 8px; color:#2c3e50 }

    .info, .error-box, .success-box {
      padding:12px; border-radius:10px; margin:8px 0; font-size:.95em; display:none;
      text-align:left;
    }
    .info       { background:#fff8e5; color:#8a6d3b; border:1px solid #ffecb5; }
    .error-box  { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; display:none }
    .success-box{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; display:none }

    .participant { line-height:1.55; color:#2c3e50; font-size:.95em; }

    .badge {
      display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.85rem;
    }
    .badge.ok { background:#e8f5e9; color:#2e7d32; }
    .badge.warn { background:#ffebee; color:#c62828; }

    .history { max-height:240px; overflow:auto; border:1px solid #eef2f5; border-radius:10px; }
    .history-item {
      padding:10px 12px; border-bottom:1px dashed #e7edf3; display:flex; gap:10px; align-items:flex-start;
    }
    .history-item:last-child{ border-bottom:none }
    .tag { font-size:.75rem; padding:3px 8px; border-radius:999px; background:#f1f5f9; color:#475569; }

    /* ===== Form fields (login) ===== */
    label.login-label {
      display: block;
      width: var(--field-width);
      margin: 12px auto 6px;
      text-align: left;
      color: #2c3e50;
      font-weight: 600;
      font-size: 0.95em;
    }
    .input-wrap {
      position: relative;
      width: var(--field-width);
      margin: 0 auto 12px;
    }
    .input-wrap input {
      width: 100%;
      padding: 12px 42px 12px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 0.95em;
      transition: all 0.25s ease;
      background: #fff; color: #2c3e50;
    }
    .input-wrap input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.25);
      outline: none;
    }
    .input-wrap input::placeholder { color: #94a3b8; }
    .toggle-visibility {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: transparent; border: none; cursor: pointer; font-size: 0.95em; color: #2c3e50; opacity: 0.8;
    }

    /* ====== Recherche participants ====== */
    .search-wrap { display:grid; gap:10px; }
    .search-meta { display:flex; justify-content:space-between; align-items:center; font-size:.9em; color:#566573 }
    .results {
      border:1px solid #eef2f5; border-radius:10px; overflow:hidden; max-height:260px; overflow:auto;
    }
    .result-item {
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
      padding:10px 12px; border-bottom:1px dashed #e7edf3;
    }
    .result-item:last-child { border-bottom:none; }
    .result-name { font-weight:700; color:#2c3e50 }
    .result-sub { font-size:.88em; color:#6b7c93 }
    .pill {
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:.75em; font-weight:700;
      background:#f1f5f9; color:#475569; margin-left:6px;
    }
    .result-actions { display:flex; gap:8px; }
    .muted { opacity:.7 }

    .hidden { display:none !important }
/* ====== R√©sultats en tableau ====== */
.results.table-wrap {
  border: 1px solid #eef2f5;
  border-radius: 10px;
  overflow: hidden;
  max-height: 260px;
  overflow: auto;
}
.results-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 520px; /* √©vite des casses sur petits √©crans */
}
.results-table th, .results-table td {
  padding: 10px 12px;
  border-bottom: 1px dashed #e7edf3;
  text-align: left;
  font-size: 0.95em;
}
.results-table th {
  background: #f8fafc;
  position: sticky; top: 0; z-index: 1;
}
.results-table tr:hover td { background: #f9fbff; }
.stat-dot {
  display: inline-flex; align-items: center; gap: 6px;
  font-weight: 600;
}
.stat-dot i {
  width: 10px; height: 10px; border-radius: 50%;
  display: inline-block;
}
.stat-ok i { background: #2ecc71; }
.stat-no i { background: #e74c3c; }
.actions-cell { display: flex; gap: 8px; }

  </style>
</head>
<body>
  <div class="card" id="app">
    <div class="card-header">
      <img src="/static/img/scanevent-logo.png" alt="Scan Event" />
      <div>
        <h1>Scan Event ‚Äì Check-in</h1>
        <div class="subtitle" id="headerSubtitle">Identifiez-vous pour lancer le scanner</div>
      </div>
      <div style="margin-left:auto" class="chip" id="cameraState">üì∑ off</div>
    </div>

    <!-- ===== Connexion ===== -->
    <div class="card-body" id="loginSection">
      <div class="video-wrap">
        <h3>Connexion Check-in</h3>
        <div class="info" id="loginTip" style="display:block">üí° Utilisez la cam√©ra arri√®re pour une lecture plus rapide.</div>
        <div class="error-box" id="loginError"></div>

        <label for="loginInput" class="login-label">Login</label>
        <div class="input-wrap">
          <input id="loginInput" type="text" placeholder="email ou identifiant" autocomplete="username" />
        </div>

        <label for="passwordInput" class="login-label">Mot de passe</label>
        <div class="input-wrap">
          <input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          <button type="button" class="toggle-visibility" id="togglePw" aria-label="Afficher/Masquer">üëÅÔ∏è</button>
        </div>

        <button class="btn" id="loginBtn">Se connecter</button>
      </div>

      <div class="panel">
        <div class="box">
          <h3>Aide</h3>
          <p class="subtitle">Vos identifiants sont fournis depuis le Dashboard QR Event. Apr√®s connexion, vous pourrez choisir la cam√©ra, r√©gler la zone de scan, activer le flash (si support√©), mettre en pause, etc.</p>
        </div>
      </div>
    </div>

    <!-- ===== Scanner + Infos ===== -->
    <div class="card-body hidden" id="scanSection">
      <div class="video-wrap">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 id="eventTitle">üéüÔ∏è √âv√©nement</h3>
          <span class="chip" id="eventInfoTag">‚Äî</span>
        </div>

        <!-- Lecteur -->
        <div id="reader">
          <div class="qr-overlay">
            <div class="qr-box" id="overlayBox">
              <span class="qr-corner tl"></span>
              <span class="qr-corner tr"></span>
              <span class="qr-corner bl"></span>
              <span class="qr-corner br"></span>
            </div>
          </div>
        </div>

        <!-- Menu Cam√©ra -->
        <div class="controls">
          <div class="control-group">
            <h4>Cam√©ra & Qualit√©</h4>
            <div class="row">
              <select id="cameraSelect"></select>
            </div>
            <div class="row">
              <label class="subtitle" for="fpsRange" style="width:120px">FPS</label>
              <input id="fpsRange" type="range" min="5" max="30" step="1" value="10">
              <span id="fpsVal" style="width:40px;text-align:right">10</span>
            </div>
            <div class="row">
              <label class="subtitle" for="qrboxRange" style="width:120px">Zone (px)</label>
              <input id="qrboxRange" type="range" min="180" max="380" step="10" value="250">
              <span id="qrboxVal" style="width:40px;text-align:right">250</span>
            </div>
            <div class="row">
              <button class="btn-outline" id="btnFlip">‚Üª Inverser</button>
              <button class="btn-outline" id="btnTorch" disabled>üî¶ Flash</button>
              <button class="btn-outline" id="btnFullscreen">‚õ∂ Plein √©cran</button>
            </div>
          </div>

          <div class="control-group">
            <h4>Actions</h4>
            <div class="row">
              <button class="btn" id="btnStart">‚ñ∂ D√©marrer</button>
              <button class="btn-outline" id="btnPause" disabled>‚è∏ Pause</button>
              <button class="btn-outline" id="btnResume" disabled>‚ñ∂ Reprendre</button>
              <button class="btn-outline" id="btnStop" disabled>‚èπ Stop</button>
            </div>
            <div class="row" style="gap:14px">
              <label><input type="checkbox" id="beepChk" checked> Bip au scan</label>
              <label><input type="checkbox" id="vibrateChk" checked> Vibration</label>
              <label><input type="checkbox" id="autoclearChk" checked> Effacer auto (1.8s)</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Panneau droit -->
      <div class="panel">
        <div class="box">
          <h3>R√©sultats / Messages</h3>
          <div id="scanBadge" class="badge hidden"></div>
          <div id="scanSuccess" class="success-box"></div>
          <div id="scanError" class="error-box"></div>

          <div class="participant" id="participantInfo"></div>
          <button id="checkinBtn" class="btn hidden" style="margin-top:10px">‚úÖ Valider le check-in</button>
        </div>

        <!-- ===== Recherche participant (remplace l'ancien "Scan manuel") ===== -->
        <div class="box">
          <h3>Recherche participant</h3>
          <div class="search-wrap">
            <input id="searchInput" type="text" placeholder="üîç Rechercher par nom ou pr√©nom‚Ä¶" autocomplete="off" />
            <div class="search-meta">
              <span class="subtitle" id="searchHint">Tapez au moins 2 caract√®res</span>
              <span class="subtitle" id="searchCount">0 r√©sultat</span>
            </div>
            <div class="results" id="searchResults"></div>
          </div>
        </div>

        <div class="box">
          <h3>Historique</h3>
          <div class="history" id="historyList"></div>
          <div class="row" style="justify-content:space-between; margin-top:10px">
            <span class="subtitle" id="historyCount">0 √©l√©ment</span>
            <button class="btn-outline" id="clearHistory">Effacer</button>
          </div>
        </div>

<div class="box">
  <h3>Liens utiles</h3>
  <div class="row" style="gap:8px; flex-wrap:wrap">
    <button class="btn-outline" id="backToLogin">‚¨Ö Retour √† la connexion</button>

    <button class="btn-outline" id="logoutBtn">üö™ Se d√©connecter</button>
  </div>
</div>


      </div>
    </div>
  </div>

  <!-- Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    // ====== State ======
    let eventId = null;
    let checkinToken = null; // token de session check-in
    let participantId = null;
    let qrScanner = null;
    let lastScanTime = 0;
    let lastTorch = false;
    let facingUser = false;
    let devicesCache = [];

    // ====== UI refs ======
    const loginSection   = document.getElementById("loginSection");
    const scanSection    = document.getElementById("scanSection");
    const loginBtn       = document.getElementById("loginBtn");
    const loginError     = document.getElementById("loginError");
    const loginInput     = document.getElementById("loginInput");
    const passwordInput  = document.getElementById("passwordInput");
    const togglePw       = document.getElementById("togglePw");
    const headerSubtitle = document.getElementById("headerSubtitle");
    const cameraState    = document.getElementById("cameraState");
    const eventTitle     = document.getElementById("eventTitle");
    const eventInfoTag   = document.getElementById("eventInfoTag");

    const reader         = document.getElementById("reader");
    const overlayBox     = document.getElementById("overlayBox");

    const cameraSelect   = document.getElementById("cameraSelect");
    const fpsRange       = document.getElementById("fpsRange");
    const fpsVal         = document.getElementById("fpsVal");
    const qrboxRange     = document.getElementById("qrboxRange");
    const qrboxVal       = document.getElementById("qrboxVal");

    const btnStart       = document.getElementById("btnStart");
    const btnPause       = document.getElementById("btnPause");
    const btnResume      = document.getElementById("btnResume");
    const btnStop        = document.getElementById("btnStop");
    const btnFlip        = document.getElementById("btnFlip");
    const btnTorch       = document.getElementById("btnTorch");
    const btnFullscreen  = document.getElementById("btnFullscreen");

    const scanBadge      = document.getElementById("scanBadge");
    const scanSuccess    = document.getElementById("scanSuccess");
    const scanErrorBox   = document.getElementById("scanError");
    const participantInfo= document.getElementById("participantInfo");
    const checkinBtn     = document.getElementById("checkinBtn");

    // Recherche
    const searchInput    = document.getElementById("searchInput");
    const searchResults  = document.getElementById("searchResults");
    const searchCount    = document.getElementById("searchCount");
    const searchHint     = document.getElementById("searchHint");

    const historyList    = document.getElementById("historyList");
    const historyCount   = document.getElementById("historyCount");
    const clearHistory   = document.getElementById("clearHistory");

    const beepChk        = document.getElementById("beepChk");
    const vibrateChk     = document.getElementById("vibrateChk");
    const autoclearChk   = document.getElementById("autoclearChk");

// Restaure la session si d√©j√† connect√©

(function restoreSession(){
  const t     = sessionStorage.getItem("checkin_token");
  const e     = sessionStorage.getItem("checkin_event_id");
  const title = sessionStorage.getItem("checkin_event_title") || "";

  if (t) {
    checkinToken = t;
    eventId = e ? Number(e) : null;

    loginSection.classList.add("hidden");
    scanSection.classList.remove("hidden");

    eventTitle.textContent = "üéüÔ∏è " + (title || "√âv√©nement");
    eventInfoTag.textContent = e ? ("ID: " + eventId) : "Session check-in active";

    populateCameras().then(startCamera).catch(()=>{});
  }
})();



    // ====== Helpers UI ======
    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }
    function clearMsgs(){
      hide(scanSuccess); hide(scanErrorBox);
      scanSuccess.innerHTML = ""; scanErrorBox.textContent = "";
      hide(scanBadge); scanBadge.textContent = ""; scanBadge.className = "badge";
    }
    function showSuccess(msg){ scanSuccess.innerHTML = msg; show(scanSuccess); hide(scanErrorBox); }
    function showError(msg){ scanErrorBox.textContent = msg; show(scanErrorBox); hide(scanSuccess); }
    function setCamState(text){ cameraState.textContent = text; }

    function beep(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.value = 880; g.gain.value = 0.05;
        o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      } catch {}
    }
    function vibrate(){ if (navigator.vibrate) navigator.vibrate(80); }

    function pushHistory(label, status){
      const div = document.createElement("div");
      div.className = "history-item";
      div.innerHTML = `
        <span class="tag">${status || "Scan"}</span>
        <div>
          <div>${label}</div>
          <div class="subtitle">${new Date().toLocaleString()}</div>
        </div>`;
      historyList.prepend(div);
      historyCount.textContent =
        historyList.childElementCount + " √©l√©ment" + (historyList.childElementCount>1?"s":"");
    }

    clearHistory.addEventListener("click", ()=>{
      historyList.innerHTML = ""; historyCount.textContent = "0 √©l√©ment";
    });

    // Parse JSON en s√©curit√© (√©vite "Unexpected token ..." sur 500 HTML)
    async function parseJSONSafe(res){
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) {
        try { return await res.json(); } catch { /* fallback */ }
      }
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch {
        return { success: false, error: txt || (res.ok ? "R√©ponse du serveur vide." : `HTTP ${res.status}`) };
      }
    }

// ====== Fetch wrapper sp√©cial check-in ======
async function fetchWithCheckinToken(url, options = {}) {
  // Mode token si on en a un, sinon mode cookie (session)
  const storedToken = sessionStorage.getItem("checkin_token");
  checkinToken = checkinToken || storedToken || null;

  // Toujours envoyer les cookies si le serveur les utilise
  options.credentials = "include";

  // Normalise le body selon qu'on a un token ou pas
  if (checkinToken) {
    if (options.body instanceof FormData) {
      if (!options.body.has('token')) options.body.append('token', checkinToken);
    } else {
      const fd = new URLSearchParams(typeof options.body === 'string' ? options.body : '');
      if (!fd.has('token')) fd.set('token', checkinToken);
      options.body = fd;
      options.headers = { ...(options.headers||{}), 'Content-Type':'application/x-www-form-urlencoded' };
    }
  } else {
    // Pas de token ‚Üí ne rien forcer, mais si c'est une simple cha√Æne, garde-la
    if (!(options.body instanceof FormData) && typeof options.body !== 'string') {
      // Laisse options.body tel quel (null/undefined) sauf si tu dois envoyer autre chose
    }
  }

  const res = await fetch(url, options);
  if (res.status === 401) {
    sessionStorage.clear();
    location.reload();
    return Promise.reject(new Error("Session expir√©e. Veuillez vous reconnecter."));
  }
  return res;
}



    // ====== Login ======
togglePw.addEventListener("click", () => {
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    togglePw.textContent = "üôà"; // oeil barr√©
  } else {
    passwordInput.type = "password";
    togglePw.textContent = "üëÅÔ∏è"; // oeil normal
  }
});
    loginBtn.addEventListener("click", doLogin);
    passwordInput.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
    function clearLoginError(){ hide(loginError); loginError.textContent = ""; }
    loginInput.addEventListener("input", clearLoginError);
    passwordInput.addEventListener("input", clearLoginError);

async function doLogin(){
  clearLoginError();
  loginBtn.disabled = true;
  loginBtn.textContent = "Connexion‚Ä¶";

  try {
    const res = await fetch("/checkin/login", {
      method: "POST",
      body: new URLSearchParams({
        login: loginInput.value.trim(),
        password: passwordInput.value
      })
    });

const data = await parseJSONSafe(res);
console.log("LOGIN KEYS:", Object.keys(data));

if (!data.success) throw new Error(data.error || "Mauvais identifiants");

// lis souplement les champs
const evTitle = data.event_title || data.title || "";
checkinToken  = data.checkin_token || data.token || data.access_token;
eventId       = data.event_id ?? data.eventId ?? data.id ?? null;

// Pas de token ? -> on passera en mode cookie (credentials: 'include')
const hasToken = !!checkinToken;
sessionStorage.setItem("checkin_has_token", hasToken ? "1" : "0");
}

// UI
eventTitle.textContent     = "üéüÔ∏è " + (evTitle || "√âv√©nement");
eventInfoTag.textContent   = eventId ? ("ID: " + eventId) : "Session check-in active";
headerSubtitle.textContent = evTitle ? `Scanner actif pour ¬´ ${evTitle} ¬ª` : "Scanner actif";

// Session
sessionStorage.setItem("checkin_token", checkinToken);
if (eventId != null) sessionStorage.setItem("checkin_event_id", String(eventId));
if (evTitle) sessionStorage.setItem("checkin_event_title", evTitle);

// Bascule
loginSection.classList.add("hidden");
scanSection.classList.remove("hidden");
await populateCameras();
await startCamera();


  } catch (err) {
    loginError.textContent = "‚ùå " + (err?.message || "Erreur serveur");
    show(loginError);
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = "Se connecter";
  }
}


    // ====== Camera control ======
    async function populateCameras(){
      try{
        devicesCache = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        devicesCache.forEach((d,i)=>{
          const opt = document.createElement("option");
          opt.value = d.id; opt.textContent = d.label || ("Cam√©ra " + (i+1));
          cameraSelect.appendChild(opt);
        });
        const back = devicesCache.find(d=>/back|rear|environment/i.test(d.label));
        if(back) cameraSelect.value = back.id;
      }catch(e){
        cameraSelect.innerHTML = "<option>Cam√©ra non disponible</option>";
      }
    }

    fpsRange.addEventListener("input", ()=> fpsVal.textContent = fpsRange.value);
    qrboxRange.addEventListener("input", ()=>{
      qrboxVal.textContent = qrboxRange.value;
      overlayBox.style.width = Math.min(520, parseInt(qrboxRange.value,10)) + "px";
      overlayBox.style.aspectRatio = "1 / 1";
    });

    document.getElementById("btnStart").addEventListener("click", startCamera);
    document.getElementById("btnPause").addEventListener("click", async ()=>{
      try { qrScanner?.pause(true); setCamState("‚è∏ pause"); btnPause.disabled=true; btnResume.disabled=false; } catch {}
    });
    document.getElementById("btnResume").addEventListener("click", async ()=>{
      try { qrScanner?.resume(); setCamState("üì∑ on"); btnResume.disabled=true; btnPause.disabled=false; } catch {}
    });
    document.getElementById("btnStop").addEventListener("click", stopCamera);

    document.getElementById("btnFlip").addEventListener("click", async ()=>{
      try {
        if (devicesCache.length >= 2 && cameraSelect.options.length >= 2) {
          const idx = cameraSelect.selectedIndex;
          const next = (idx + 1) % cameraSelect.options.length;
          cameraSelect.selectedIndex = next;
          facingUser = /front|user/i.test(cameraSelect.options[next].textContent);
        } else {
          facingUser = !facingUser;
          cameraSelect.value = ""; // force facingMode
        }
        await startCamera();
      } catch {}
    });

    document.getElementById("btnFullscreen").addEventListener("click", ()=>{
      const el = document.documentElement;
      if (!document.fullscreenElement) el.requestFullscreen?.();
      else document.exitFullscreen?.();
    });

    document.getElementById("btnTorch").addEventListener("click", async ()=>{
      try {
        const video = reader.querySelector("video");
        const track = video?.srcObject?.getVideoTracks?.()[0];
        const caps  = track?.getCapabilities?.();
        if (caps && "torch" in caps) {
          lastTorch = !lastTorch;
          await track.applyConstraints({ advanced:[{ torch: lastTorch }] });
          btnTorch.textContent = lastTorch ? "üî¶ Flash (ON)" : "üî¶ Flash";
        }
      } catch {}
    });

    async function startCamera(){
      clearMsgs();
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnPause.disabled = false;
      btnResume.disabled = true;
      setCamState("‚è≥‚Ä¶");
      try{
        if(!qrScanner) qrScanner = new Html5Qrcode("reader");
        try { if (qrScanner.isScanning) await qrScanner.stop(); } catch {}

        const facingConstraint = cameraSelect.value
          ? { deviceId: { exact: cameraSelect.value } }
          : { facingMode: facingUser ? "user" : "environment" };

        const fps = parseInt(fpsRange.value, 10) || 10;
        const box = parseInt(qrboxRange.value, 10) || 250;

        await qrScanner.start(
          facingConstraint,
          { fps, qrbox: box },
          onScanSuccess,
          ()=>{} // ignore frame errors
        );
        setCamState("üì∑ on");

        const video = reader.querySelector("video");
        const track = video?.srcObject?.getVideoTracks?.()[0];
        const caps  = track?.getCapabilities?.();
        btnTorch.disabled = !(caps && "torch" in caps);
      }catch(err){
        showError("‚ùå Acc√®s cam√©ra impossible : " + (err?.message || err));
        setCamState("üì∑ off");
        btnStop.disabled = true; btnPause.disabled=true; btnResume.disabled=true;
      }finally{
        btnStart.disabled = false;
      }
    }

    async function stopCamera(){
      try{
        if(qrScanner && qrScanner.isScanning){ await qrScanner.stop(); }
        setCamState("üì∑ off");
        btnStop.disabled = true; btnPause.disabled=true; btnResume.disabled=true;
      }catch{}
    }

    // ====== Scan handlers ======
    function onScanSuccess(qrText){
      const now = Date.now();
      if (now - lastScanTime < 900) return; // anti double scan
      lastScanTime = now;

      if (beepChk.checked) beep();
      if (vibrateChk.checked) vibrate();

      pushHistory(qrText, "Scan");
      handleQr(qrText);
    }

    function handleQr(qrInput){
      try {
        const url = new URL(qrInput);
        participantId = url.searchParams.get("participant");
      } catch {
        participantId = qrInput; // ID brut
      }
      if (participantId) doScan();
    }

    async function doScan(){
      clearMsgs();
      try{
        const paramsScan = new URLSearchParams({ qr_code: participantId });
        if (eventId) paramsScan.set("event_id", eventId);

        const res = await fetchWithCheckinToken("/checkin/scan", {
                        method:"POST",
                        body: paramsScan
                   });

        const data = await parseJSONSafe(res);

        if(data.success && data.participant){
          const p = data.participant;

          scanBadge.textContent = p.scanned ? "D√©j√† scann√©" : "Nouveau / pr√™t √† valider";
          scanBadge.className = "badge " + (p.scanned ? "warn" : "ok");
          show(scanBadge);

          participantInfo.innerHTML = `
            <p><b>${p.first_name} ${p.last_name}</b></p>
            <p>Email : ${p.email}</p>
            <p>Pay√© : ${p.amount_paid}‚Ç¨</p>
            <p>√âv√©nement : ${p.event_title}</p>
            <p>Date : ${p.date}</p>
            <p>Lieu : ${p.location}</p>
          `;

          if (!p.scanned) {
            checkinBtn.classList.remove("hidden");
          } else {
            checkinBtn.classList.add("hidden");
          }

          const firstItem = historyList.querySelector(".history-item");
          if (firstItem) {
            const labelDiv = firstItem.querySelector("div > div:first-child");
            if (labelDiv) labelDiv.textContent = `${p.first_name} ${p.last_name} (${p.email})`;
            const tag = firstItem.querySelector(".tag");
            if (tag) tag.textContent = p.scanned ? "D√©j√† scann√©" : "Nouveau";
          }

          if (autoclearChk.checked && p.scanned){
            setTimeout(()=>{ clearMsgs(); participantInfo.innerHTML=""; }, 1800);
          }
        }else{
          participantInfo.innerHTML = "";
          const msg = data.message || data.error || "Erreur pendant le scan.";
          showError(msg);
          checkinBtn.classList.add("hidden");
        }
      }catch(err){
        showError("‚ùå Erreur serveur : " + (err?.message || err));
      }
    }

    checkinBtn.addEventListener("click", validateCheckin);
    async function validateCheckin(){
      clearMsgs();
      try{
     const paramsVal = new URLSearchParams({ qr_code: participantId });
     if (eventId) paramsVal.set("event_id", eventId);

     const res = await fetchWithCheckinToken("/checkin/validate", {
                 method:"POST",
                 body: paramsVal
           });


        const data = await parseJSONSafe(res);
        if(data.success){
          showSuccess("‚úÖ " + (data.message || "Check-in valid√©") + "<br>Vous pouvez scanner un nouveau participant‚Ä¶");
          checkinBtn.classList.add("hidden");
          participantInfo.innerHTML = "";
          if (autoclearChk.checked){ setTimeout(()=>{ clearMsgs(); }, 1800); }
        }else{
          showError(data.message || data.error || "Validation impossible.");
        }
      }catch(err){
        showError("‚ùå Erreur serveur : " + (err?.message || err));
      }
    }

    // ====== Recherche participants (nouveau) ======
    let searchTimer = null;

    searchInput.addEventListener("input", ()=>{
      const q = searchInput.value.trim();
      if (q.length === 0){
        searchResults.innerHTML = "";
        searchCount.textContent = "0 r√©sultat";
        searchHint.textContent = "Tapez au moins 2 caract√®res";
        return;
      }
      if (q.length < 2){
        searchHint.textContent = "‚ûú Encore 1 caract√®re‚Ä¶";
        return;
      }
      searchHint.textContent = "Recherche‚Ä¶";
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> searchParticipants(q), 220); // debounce
    });

    // Entr√©e = ouvrir la 1√®re ligne s'il y en a

    searchInput.addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    const firstBtn =
      document.querySelector(".results-table tbody tr button[data-action='afficher']");
    if (firstBtn) firstBtn.click();
  }
});


async function searchParticipants(query){
  const hasToken = !!(sessionStorage.getItem("checkin_token"));
  try{
    let res, body, headers;
    if (hasToken) {
      body = JSON.stringify({ token: sessionStorage.getItem("checkin_token"), q: query });
      headers = { "Content-Type": "application/json" };
    } else {
      body = JSON.stringify({ q: query }); // pas de token
      headers = { "Content-Type": "application/json" };
    }

    res = await fetch("/checkin/search", {
      method: "POST",
      headers,
      body,
      credentials: "include"
    });

    const data = await parseJSONSafe(res);
    if (!data.success) {
      searchResults.innerHTML = "";
      searchCount.textContent = "0 r√©sultat";
      searchHint.textContent  = data.error || "Aucun r√©sultat";
      return;
    }
    renderSearchResults(Array.isArray(data.results) ? data.results : []);
  } catch(err){
    searchResults.innerHTML = "";
    searchCount.textContent = "0 r√©sultat";
    searchHint.textContent  = "‚ùå Erreur serveur : " + (err?.message || err);
  }
}
 // üëà FIN DE searchParticipants

function escapeHtml(s){
  return (s || "").replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
  ));
}

function renderSearchResults(list){
  const count = Array.isArray(list) ? list.length : 0;
  searchCount.textContent = `${count} r√©sultat${count > 1 ? "s" : ""}`;

  if (!count){
    searchResults.classList.add("table-wrap");
    searchResults.innerHTML = `
      <table class="results-table">
        <thead>
          <tr>
            <th>Nom</th><th>Email</th><th>Ticket</th><th>Check-in</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">Aucun participant trouv√©.</td></tr>
        </tbody>
      </table>`;
    return;
  }

  const rowsHtml = list.map(p=>{
    const id        = p.id;
    const fullname  = p.name || "‚Äî";
    const email     = p.email || "‚Äî";
    const ticket    = p.ticket_id || "‚Äî";
    const scanned   = !!p.scanned_at;

    const statHtml = scanned
      ? `<span class="stat-dot stat-ok"><i></i>‚úÖ</span>`
      : `<span class="stat-dot stat-no"><i></i>‚ùå</span>`;

    // On utilisera le ticket_id comme payload "qr" quand il existe, sinon l'id
    const qr = ticket !== "‚Äî" ? ticket : String(id);

    return `
      <tr data-qr="${qr}">
        <td>${escapeHtml(fullname)}</td>
        <td>${escapeHtml(email)}</td>
        <td>${escapeHtml(ticket)}</td>
        <td>${statHtml}</td>
        <td class="actions-cell">
          <button class="btn-outline" data-action="afficher">Afficher</button>
          <button class="btn" data-action="checkin"${scanned ? " disabled title='D√©j√† scann√©'":""}>Check-in</button>
        </td>
      </tr>`;
  }).join("");

  searchResults.classList.add("table-wrap");
  searchResults.innerHTML = `
    <table class="results-table">
      <thead>
        <tr>
          <th>Nom</th><th>Email</th><th>Ticket</th><th>Check-in</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>`;

  // Actions
  searchResults.querySelectorAll("tbody tr").forEach(tr=>{
    const qr = tr.getAttribute("data-qr");
    const btnShow  = tr.querySelector("button[data-action='afficher']");
    const btnCheck = tr.querySelector("button[data-action='checkin']");

    btnShow?.addEventListener("click", ()=>{
      if (!qr) return;
      pushHistory(qr, "Recherche");
      participantId = qr;     // r√©utilise ton flux existant
      doScan();               // appelle /checkin/scan puis affiche la fiche
    });

    btnCheck?.addEventListener("click", async ()=>{
      if (!qr) return;
      pushHistory(qr, "Check-in (recherche)");
      participantId = qr;
      await doScan();         // affiche la fiche
      if (!checkinBtn.classList.contains("hidden")){
        validateCheckin();    // appelle /checkin/validate (ton flux existant)
      }
    });
  });
} //üëà FIN DE renderSearchResults

// ====== Boot misc ======
fpsVal.textContent = fpsRange.value;
qrboxVal.textContent = qrboxRange.value;

document.getElementById("logoutBtn")?.addEventListener("click", () => {
  sessionStorage.clear();
  location.reload();
});

document.getElementById("backToLogin")?.addEventListener("click", () => {
  sessionStorage.clear(); // Efface le token check-in
  window.location.href = "/static/scan_event.html"; // Renvoie √† la page login du scan
});

 </script>
</body>
</html>
