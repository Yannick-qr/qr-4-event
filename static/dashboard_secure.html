<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin</title>
  <script>
    async function loadPayPalSdk() {
      const res = await fetch("/api/paypal-client-id");
      const data = await res.json();
      if (data.client_id) {
        const script = document.createElement("script");
        script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
        script.async = true;
        document.head.appendChild(script);
      } else {
        console.error("Erreur PayPal:", data.error || "client_id manquant");
      }
    }
    loadPayPalSdk();
  </script>
  <style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6fa;
  margin: 0;
  padding: 0;
  padding-top: 180px;  /* espace pour compenser header + nav */
 box-sizing: border-box;
}
header {
  background: #007bff;
  color: white;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;     /* fige le header */
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;       /* toujours au-dessus */
box-sizing: border-box; /* √©vite d√©bordements */
}
nav {
  background: #e9ecef;
  padding: 10px;
  display: flex;
  justify-content: center;
  gap: 20px;
  position: fixed;    /* fige la barre grise */
  top: 120px;         /* se place juste sous le header bleu */
  left: 0;
  width: 100%;
  z-index: 999;
box-sizing: border-box;
}
    nav button { padding: 10px 15px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
    nav button.active { background: #0056b3; }
    #logoutBtn { background: red; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #007bff; color: white; }
    .action-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
    .edit-btn { background: #ffc107; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .toggle-btn { background: #17a2b8; color: white; }
    .link-btn { background: #28a745; color: white; }
    form#addEventForm { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    form#addEventForm input, form#addEventForm textarea { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 5px; }
    form#addEventForm button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    form#addEventForm button:hover { background: #0056b3; }
    #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #editModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:400px; }
    #editModal input, #editModal textarea { width:100%; margin:6px 0; padding:8px; border:1px solid #ccc; border-radius:5px; }
    #editModal button { margin-top:10px; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; }
    #saveEditBtn { background:#28a745; color:white; }
    #cancelEditBtn { background:#dc3545; color:white; }
    .stats { display: flex; gap: 20px; margin: 20px 0; }
    .stat { background: white; padding: 20px; border-radius: 10px; flex: 1; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .stat h3 { font-size: 24px; margin: 0; }
    #langSelector button { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; margin: 0 2px; }
    #langSelector button.active-lang { background: #0056b3; color: white; font-weight: bold; border: 1px solid #003f7f; }
    #creditPacks { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
    #creditPacks .pack { border: 2px solid #ddd; border-radius: 8px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s ease; font-size: 15px; background: #f9f9f9; }
    #creditPacks .pack:hover { border-color: #007bff; background: #eef6ff; transform: translateY(-2px); }
    #creditPacks .pack.selected { border-color: #007bff; background: #dceeff; font-weight: bold; }
    #creditPacks .credits { color: #333; }
    #creditPacks .price { color: #007bff; font-weight: bold; }
  </style>
</head>
<body>
<header>
  <h1 id="headerTitle">Dashboard Admin</h1>
<div style="position:absolute; left:50%; transform:translateX(-50%); 
            background:white; padding:10px; border-radius:12px; 
            box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <img src="/static/img/qrevent-logo.png" 
       alt="Logo QR EVENT" 
       style="height:80px; width:auto; display:block;">
</div>
  <div style="text-align:right; font-size:14px;">
    <div><b id="connectedAs">Connect√© en tant que : </b><span id="userEmail"></span></div>
  <button id="logoutBtn" style="
    background: red;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 6px;
    display: inline-block;
  ">
    D√©connexion
  </button>
    <div id="langSelector" style="margin-top:8px;">
      <button data-lang="fr" onclick="setLanguage('fr')">FR</button>
      <button data-lang="en" onclick="setLanguage('en')">EN</button>
    </div>
  </div>
</header>

  <!-- BARRE DE NAVIGATION GRISE -->
<nav>
  <button class="nav-btn" onclick="window.open('paid_registrations.html', '_blank')">
    üìã Inscriptions Pay√©es
  </button>
  <button id="eventsBtn" class="active" data-i18n="events">√âv√©nements</button>
  <button id="buyCreditsBtn" data-i18n="buyCredits">Acheter des cr√©dits</button>
  <!-- Logo ScanEvent comme bouton ouvrant une nouvelle fen√™tre -->
<a href="scan_event.html" target="_blank">
  <img src="/static/img/scanevent-logo.png" 
       alt="Scan Event" 
       style="height:65px; width:auto; margin-left:20px; cursor:pointer; padding:5px; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
</a>
</nav>

<div id="paypalModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:400px; text-align:center; position:relative;">
    <span id="closePaypalModal" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;">‚ùå</span>
    <h3 data-i18n="buyCredits">Acheter des cr√©dits</h3>
    <div id="creditPacks"></div>
    <div id="paypal-button-container"></div>
  </div>
</div>

<section id="events" class="active">
  <h2 data-i18n="stats">Statistiques</h2>
  <div class="stats">
    <div class="card stat"><h3 id="totalEvents">0</h3><p data-i18n="eventsCreated">√âv√©nements cr√©√©s</p></div>
    <div class="card stat"><h3 id="activeEvents">0</h3><p data-i18n="eventsActive">√âv√©nements actifs</p></div>
    <div class="card stat"><h3 id="inactiveEvents">0</h3><p data-i18n="eventsInactive">√âv√©nements inactifs</p></div>
    <div class="card stat"><h3 id="eventCredits">0</h3><p data-i18n="creditsAvailable">Cr√©dits disponibles</p></div>
  </div>
  <h2 data-i18n="manageEvents">Gestion des √©v√©nements</h2>
  <form id="addEventForm">
    <h3 data-i18n="addEvent">Ajouter un nouvel √©v√©nement</h3>
    <input type="text" id="title" placeholder="Titre" required>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="date" id="date" required>
    <input type="text" id="location" placeholder="Lieu" required>
    <input type="number" id="price" placeholder="Prix (‚Ç¨)" required step="0.01">
<input type="text" id="checkin_login" placeholder="Login Check-in">
<input type="password" id="checkin_password" placeholder="Password Check-in">
    <button type="submit" data-i18n="createEvent">Cr√©er l‚Äô√©v√©nement</button>
  </form>
  <table id="eventsTable">
    <thead>
      <tr>
        <th data-i18n="title">Titre</th><th data-i18n="description">Description</th>
        <th data-i18n="date">Date</th><th data-i18n="location">Lieu</th>
        <th data-i18n="price">Prix</th><th data-i18n="status">Identifiant Scanner</th>
<th>Login Check-in</th>
        <th data-i18n="publicLink">Lien public</th><th data-i18n="actions">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<div id="editModal">
  <div class="modal-content">
    <h3 data-i18n="editEvent">√âditer l'√©v√©nement</h3>
    <form id="editEventForm">
      <input type="hidden" id="edit_id">
      <label data-i18n="title">Titre :</label><input type="text" id="edit_title" required>
      <label data-i18n="description">Description :</label><textarea id="edit_description" required></textarea>
      <label data-i18n="date">Date :</label><input type="date" id="edit_date" required>
      <label data-i18n="location">Lieu :</label><input type="text" id="edit_location" required>
      <label data-i18n="price">Prix (‚Ç¨) :</label><input type="number" id="edit_price" step="0.01" required>
<label>Login Check-in :</label>
<input type="text" id="edit_checkin_login">
<label>Mot de passe Check-in :</label>
<input type="password" id="edit_checkin_password">
      <button type="submit" id="saveEditBtn">üíæ <span data-i18n="save">Enregistrer</span></button>
      <button type="button" id="cancelEditBtn">‚ùå <span data-i18n="cancel">Annuler</span></button>
    </form>
  </div>
</div>

<script>
const translations = {
  fr: {
    events: "√âv√©nements", buyCredits: "Acheter des cr√©dits", stats: "Statistiques",
    eventsCreated: "√âv√©nements cr√©√©s", eventsActive: "√âv√©nements actifs", eventsInactive: "√âv√©nements inactifs", creditsAvailable: "Cr√©dits disponibles",
    manageEvents: "Gestion des √©v√©nements", addEvent: "Ajouter un nouvel √©v√©nement", createEvent: "Cr√©er l‚Äô√©v√©nement",
    title: "Titre", description: "Description", date: "Date", location: "Lieu", price: "Prix", status: "Statut", publicLink: "Lien public", actions: "Actions",
    editEvent: "√âditer l'√©v√©nement", save: "Enregistrer", cancel: "Annuler"
  },
  en: {
    events: "Events", buyCredits: "Buy credits", stats: "Statistics",
    eventsCreated: "Events created", eventsActive: "Active events", eventsInactive: "Inactive events", creditsAvailable: "Credits available",
    manageEvents: "Manage events", addEvent: "Add a new event", createEvent: "Create event",
    title: "Title", description: "Description", date: "Date", location: "Location", price: "Price", status: "Status", publicLink: "Public link", actions: "Actions",
    editEvent: "Edit event", save: "Save", cancel: "Cancel"
  }
};

function setLanguage(lang) {
  document.querySelectorAll("#langSelector button").forEach(btn => btn.classList.remove("active-lang"));
  document.querySelector(`#langSelector button[data-lang="${lang}"]`).classList.add("active-lang");
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = translations[lang][key];
  });
}

const token = localStorage.getItem("token");
if (!token) window.location.href = "/static/login.html";

// ‚úÖ Charger infos utilisateur
async function loadUserInfo() {
  const res = await fetch("/me", { method: "POST", body: new URLSearchParams({ token }) });
  const data = await res.json();
  document.getElementById("userEmail").textContent = data.success ? data.email : "Non connect√©";
}
loadUserInfo();

// ‚úÖ D√©connexion
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("token");
  window.location.href = "/static/login.html";
});

// ‚úÖ Gestion cr√©dits (packs PayPal)
let CREDIT_PACKS = {};
let selectedPack = null;
let paypalRendered = false;

async function loadConfig() {
  try {
    const res = await fetch("/api/config");
    const data = await res.json();
    if (!data.success) return console.error("Erreur config:", data.error);

    CREDIT_PACKS = data.packs;
    const container = document.getElementById("creditPacks");
    container.innerHTML = "";

    Object.entries(CREDIT_PACKS).forEach(([key, pack]) => {
      const div = document.createElement("div");
      div.className = "pack";
      div.innerHTML = `<span class="credits">${pack.credits >= 9999 ? "Illimit√© (1 an)" : pack.credits + " cr√©dits"}</span><span class="price">${pack.price}‚Ç¨</span>`;
      div.onclick = (e) => selectPack(key, e);
      container.appendChild(div);
    });

    const firstKey = Object.keys(CREDIT_PACKS)[0];
    selectedPack = CREDIT_PACKS[firstKey];
    container.querySelector(".pack").classList.add("selected");
  } catch (err) {
    console.error("Impossible de charger la config:", err);
  }
}

function selectPack(packKey, event) {
  selectedPack = CREDIT_PACKS[packKey];
  document.querySelectorAll("#creditPacks .pack").forEach(el => el.classList.remove("selected"));
  event.currentTarget.classList.add("selected");
}

document.getElementById("buyCreditsBtn").addEventListener("click", () => {
  paypalModal.style.display = "flex";
  if (!paypalRendered) {
    paypal.Buttons({
      createOrder: function() {
        return fetch("/paypal/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "credits", credits: selectedPack.credits })
        }).then(res => res.json()).then(order => order.id);
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          fetch("/admin/credits/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: token, credits: selectedPack.credits, payment_id: details.id })
          }).then(res => res.json()).then(resp => {
            if (resp.success) {
              alert("‚úÖ " + (selectedPack.credits >= 9999 ? "Pack illimit√©" : selectedPack.credits + " cr√©dits") + " ajout√©s !");
              paypalModal.style.display = "none";
              loadEvents();
            } else {
              alert("‚ùå Erreur backend : " + (resp.error || "Impossible d‚Äôajouter les cr√©dits"));
            }
          });
        });
      }
    }).render("#paypal-button-container");
    paypalRendered = true;
  }
});

const paypalModal = document.getElementById("paypalModal");
document.getElementById("closePaypalModal").addEventListener("click", () => paypalModal.style.display = "none");
window.addEventListener("click", (e) => { if (e.target === paypalModal) paypalModal.style.display = "none"; });

// ‚úÖ Charger √©v√©nements et stats
async function loadEvents() {
  const res = await fetch("/admin/events/list", { method: "POST", body: new URLSearchParams({ token }) });
  const data = await res.json();
  if (!data.success) return alert(data.error || "Erreur √©v√©nements");

  const tbody = document.querySelector("#eventsTable tbody");
  tbody.innerHTML = "";
  data.events.forEach(ev => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${ev.title}</td><td>${ev.description}</td><td>${ev.date}</td>
      <td>${ev.location}</td><td>${ev.price} ‚Ç¨</td>
<td>
  ${ev.checkin_login ? "<b>Login : </b>" + ev.checkin_login : "‚ùå Non d√©fini"}<br>
  ${ev.checkin_password ? "<b>Password : </b>" + ev.checkin_password : ""}
</td>
      <td>${ev.is_active ? "‚úÖ Actif" : "‚ùå Inactif"}</td>

      <td><a href="${ev.public_url}" target="_blank"><button class="action-btn link-btn">üîó Voir</button></a></td>
      <td>
        <button class="action-btn edit-btn" onclick='editEvent(${JSON.stringify(ev)})'>‚úèÔ∏è</button>
        <button class="action-btn delete-btn" onclick="deleteEvent(${ev.id})">üóëÔ∏è</button>
        <button class="action-btn toggle-btn" onclick="toggleEvent(${ev.id})">${ev.is_active ? "D√©sactiver" : "Activer"}</button>
      </td>`;
    tbody.appendChild(row);
  });

  document.getElementById("totalEvents").textContent = data.events.length;
  document.getElementById("activeEvents").textContent = data.events.filter(e => e.is_active).length;
  document.getElementById("inactiveEvents").textContent = data.events.filter(e => !e.is_active).length;
  document.getElementById("eventCredits").textContent = data.credits ?? 0;
}
loadEvents();
loadConfig();

// ‚úÖ Gestion √©dition / suppression
function editEvent(ev) {
  document.getElementById("edit_id").value = ev.id;
  document.getElementById("edit_title").value = ev.title;
  document.getElementById("edit_description").value = ev.description;
  document.getElementById("edit_date").value = ev.date;
  document.getElementById("edit_location").value = ev.location;
  document.getElementById("edit_price").value = ev.price;
  document.getElementById("edit_checkin_login").value = ev.checkin_login || "";
  document.getElementById("edit_checkin_password").value = ev.checkin_password || "";

  document.getElementById("editModal").style.display = "flex";
}
document.getElementById("cancelEditBtn").addEventListener("click", () => document.getElementById("editModal").style.display = "none");

async function deleteEvent(id) {
  if (!confirm("Supprimer l‚Äô√©v√©nement ?")) return;
  const form = new URLSearchParams();
  form.append("token", token);
  form.append("event_id", id);

  const res = await fetch("/admin/events/delete", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur suppression : " + (data.error || ""));
}


async function toggleEvent(id) {
  const form = new URLSearchParams();
  form.append("token", token);
  form.append("event_id", id);

  const res = await fetch("/admin/events/toggle", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur activation/d√©sactivation : " + (data.error || ""));
}


// ‚úÖ Sauvegarde modification
document.getElementById("editEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new URLSearchParams();
  form.append("event_id", document.getElementById("edit_id").value);
  form.append("title", document.getElementById("edit_title").value);
  form.append("description", document.getElementById("edit_description").value);
  form.append("date", document.getElementById("edit_date").value);
  form.append("location", document.getElementById("edit_location").value);
  form.append("price", document.getElementById("edit_price").value);
  form.append("token", token);
form.append("checkin_login", document.getElementById("edit_checkin_login").value);
form.append("checkin_password", document.getElementById("edit_checkin_password").value);

  const res = await fetch("/admin/events/update", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) {
    alert("‚úÖ √âv√©nement modifi√©");
    document.getElementById("editModal").style.display = "none";
    loadEvents();
  } else {
    alert("‚ùå Erreur modification : " + (data.error || ""));
  }
});

// ‚úÖ Cr√©ation d‚Äôun nouvel √©v√©nement
document.getElementById("addEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new URLSearchParams();
  form.append("title", document.getElementById("title").value);
  form.append("description", document.getElementById("description").value);
  form.append("date", document.getElementById("date").value);
  form.append("location", document.getElementById("location").value);
  form.append("price", document.getElementById("price").value);
  form.append("token", token);
form.append("checkin_login", document.getElementById("checkin_login").value);
form.append("checkin_password", document.getElementById("checkin_password").value);

  const res = await fetch("/admin/events", {
    method: "POST",
    body: form
  });
  const data = await res.json();

  if (data.success) {
    alert("‚úÖ √âv√©nement cr√©√© !");
    document.getElementById("addEventForm").reset();
    loadEvents(); // rafra√Æchit la liste et les stats
  } else {
    alert("‚ùå Erreur cr√©ation : " + (data.error || "Impossible de cr√©er l‚Äô√©v√©nement"));
  }
});

// ========================
// ‚è∞ D√©connexion auto apr√®s 15 min d‚Äôinactivit√©
// ========================
let inactivityTimer;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    localStorage.removeItem("token");

    // ‚ûï Stocker la raison
    sessionStorage.setItem("logoutReason", "Vous avez √©t√© d√©connect√© pour cause d'inactivit√©.");

    // Redirection
    window.location.href = "/static/login.html";
  }, 900000); // en ms = 15 min
}

["mousemove", "keydown", "click", "scroll"].forEach(evt => {
  window.addEventListener(evt, resetInactivityTimer);
});
resetInactivityTimer();

</script>
</body>
</html>
