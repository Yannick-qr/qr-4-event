<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin</title>
  <script>
    async function loadPayPalSdk() {
      const res = await fetch("/api/paypal-client-id");
      const data = await res.json();
      if (data.client_id) {
        const script = document.createElement("script");
        script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
        script.async = true;
        document.head.appendChild(script);
      } else {
        console.error("Erreur PayPal:", data.error || "client_id manquant");
      }
    }
    loadPayPalSdk();
  </script>

<!-- ✅ cache-busting pour éviter une vieille version -->
<script src="/static/js/admin-token.js?v=2025-09-05" defer></script>

<style>
  
/* ====== RESET & BASE ====== */
*,
*::before,
*::after {
  box-sizing: border-box;
}
body {
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: #f4f7fb;
  margin: 0;
  padding: 0; /* ❌ on retire le padding-top */
  color: #1f2937;
  line-height: 1.6;
}


/* ====== HEADER ====== */
header {
  background: white;
  color: #1f2937;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 60px; /* Hauteur fixe */
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #1f2937; /* pour que le titre reste visible */
}

header img {
  max-height: 70px;
}

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  height: calc(100vh - 60px);
  width: 220px; /* ✅ largeur fixe */
  background: #fff;
  border-right: 1px solid #e5e7eb;
  box-shadow: 2px 0 6px rgba(0,0,0,0.08);
  overflow: auto;
  transition: none; /* ✅ pas d’animation */
}

.layout {
  display: flex;
  margin-top: 60px; /* compense uniquement la hauteur du header */
  height: calc(100vh - 60px);
}
main {
  flex: 1;
  margin-left: 220px;  /* colle bien après la sidebar */
  padding: 20px;
  background: #f4f7fb;
  min-height: calc(100vh - 60px);
}


.sidebar button,
.sidebar a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border: none;
  background: none;
  font-size: 14px;
  color: #374151;
  cursor: pointer;
  width: 100%;
  text-align: left;
  transition: background 0.2s ease;
}

.sidebar button:hover,
.sidebar a:hover {
  background: #f1f5f9;
}

.sidebar img {
  height: 24px;
  width: 24px;
}

/* ====== NAVIGATION ====== */
nav {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 12px 20px;
  display: flex;
  justify-content: center;
  gap: 18px;
  position: fixed;
  top: 120px; left: 0;
  width: 100%;
  z-index: 999;
  box-shadow: 0 2px 5px rgba(0,0,0,0.06);
}

nav button {
  padding: 10px 18px;
  border: none;
  background: #f1f5f9;
  color: #374151;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

nav button:hover {
  background: #e2e8f0;
}

nav button.active {
  background: #007bff;
  color: #fff;
}

#logoutBtn {
  background: #dc2626 !important;
}
/* ====== Sous-navigation (Événements) ====== */
.subnav {
  display: flex;
  gap: 10px;
  margin: 10px 0 20px 0;  /* espace au-dessus et en-dessous */
}

.subnav button {
  padding: 8px 14px;
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  color: #374151;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.subnav button:hover {
  background: #e5e7eb;
}

.subnav button.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

/* ====== SECTIONS ====== */
section {
  display: none;
  padding: 30px 20px;
  max-width: 1200px;
  margin: 0;
}

section.active {
  display: block;
}

h2 {
  margin-bottom: 18px;
  font-size: 22px;
  color: #1e40af;
  border-left: 4px solid #007bff;
  padding-left: 10px;
}

/* ====== STATS ====== */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin: 25px 0;
}
.subsection { display: none; }
.subsection.active { display: block; }

.stat {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}

.stat:hover {
  transform: translateY(-3px);
}

.stat h3 {
  font-size: 28px;
  margin: 0;
  color: #111827;
}

/* ====== FORMULAIRES ====== */
form {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}

form label {
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  display: block;
  margin-top: 12px;
}

.input,
form input,
form textarea,
form select {
  width: 100%;
  padding: 10px 12px;
  margin-top: 6px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.input:focus,
form input:focus,
form textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

form button {
  margin-top: 20px;
  background: #007bff;
  color: white;
  padding: 12px 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s ease;
}

form button:hover {
  background: #0056b3;
}

/* ====== TABLES ====== */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 20px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  background: #fff;
}

th, td {
  padding: 14px 16px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
  font-size: 14px;
}

th {
  background: #007bff;
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 13px;
}

tbody tr:nth-child(even) {
  background: #f9fafb;
}

tbody tr:hover {
  background: #eef6ff;
}

/* ====== BUTTONS ====== */
.action-btn,
.btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn:hover,
.action-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.edit-btn { background: #f59e0b; color: white; }
.delete-btn { background: #dc2626; color: white; }
.toggle-btn { background: #0ea5e9; color: white; }
.link-btn { background: #22c55e; color: white; }

/* Bouton standard bleu */
.btn {
  background: #007bff;
  color: white;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.btn-danger { background: #dc2626; }
.btn-warning { background: #f59e0b; }
.btn-primary { background: #007bff; }

/* ====== MODALES ====== */
#editModal,
#deletePaypalModal {
  display: none;
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
  z-index:2000;
  padding:20px;
}

#editModal .modal-content,
#deletePaypalModal > div {
  background:#fff;
  padding:25px;
  border-radius:12px;
  width:90%;
  max-width:500px;
  max-height:80vh;
  overflow-y:auto;
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
}
/* ===== User Menu ===== */
.user-menu {
  position: relative;
  display: inline-block;
  margin-right: 20px;
}

.user-trigger {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 30px;
  background: rgba(255,255,255,0.2);
  color: white;
  transition: background 0.2s ease;
}

.user-trigger:hover {
  background: rgba(255,255,255,0.3);
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}

/* Dropdown */
.user-dropdown {
  position: absolute;
  top: 110%;
  right: 0;
  width: 240px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  padding: 15px;
  display: none;
  flex-direction: column;
  z-index: 2000;
  animation: fadeIn 0.2s ease;
}

.user-menu:hover .user-dropdown {
  display: flex;
}

.user-info {
  text-align: center;
  margin-bottom: 10px;
}

.avatar-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  margin-bottom: 8px;
}

.btn-profile {
  padding: 6px 10px;
  background: #007bff;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

.btn-profile:hover {
  background: #0056b3;
}

/* Langues */
.lang-select {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 8px 0;
}

.lang-select button {
  padding: 4px 10px;
  border: 1px solid #ccc;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.lang-select button:hover {
  background: #e5e7eb;
}

/* Déconnexion */
.btn-logout {
  margin-top: 10px;
  padding: 8px;
  background: #dc2626;
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.btn-logout:hover {
  background: #b91c1c;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to   { opacity: 1; transform: translateY(0); }
}

  </style>
</head>


<body>
    
<header>
  <div style="display:flex; align-items:center; gap:6px;">
    <img src="https://luqmxczcojngdjwjaeod.supabase.co/storage/v1/object/public/event-images/file_00000000aa10622fa1b5358f2877d5c082.png" 
         alt="Logo QR EVENT" 
         style="height:60px; width:auto; margin-right:6px; object-fit:contain; object-position:left;">
    <h1 id="headerTitle" style="margin:0; font-size:24px; font-weight:600;">QR Event</h1>
  </div>

  <!-- ===== User Menu ===== -->
  <div class="user-menu">
    <div class="user-trigger">
      <!-- 👉 Avatar seul dans le header -->
      <img src="https://luqmxczcojngdjwjaeod.supabase.co/storage/v1/object/public/event-images/Avatar.png" 
           alt="Avatar" class="avatar">
    </div>
    
    <div class="user-dropdown">
      <div class="user-info">
        <img src="https://luqmxczcojngdjwjaeod.supabase.co/storage/v1/object/public/event-images/Avatar.png" 
             alt="Avatar" class="avatar-large">
        
        <!-- 👉 Nom + Prénom depuis l’API -->
        <p><strong id="userName">Chargement...</strong></p>
        
        <button class="btn-profile">Voir Profil</button>
      </div>
      <hr>
      <div class="lang-select">
        <button data-lang="fr" onclick="setLanguage('fr')">FR</button>
        <button data-lang="en" onclick="setLanguage('en')">EN</button>
      </div>
      <button id="logoutBtn" class="btn-logout">🚪 Déconnexion</button>
    </div>
  </div>
</header>



<!-- WRAPPER -->
<div class="layout">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
      <button id="homeBtn">🏠 Accueil</button>
    <button id="eventsBtn" class="active">📅 Événements</button>
    <button id="paidRegistrationsBtn">📋 Inscriptions Payées</button>
    <button id="buyCreditsBtn">💳 Acheter des crédits</button>
    <button id="paypalConfigBtn">⚙️ Mon PayPal</button>
    <button id="logsBtn">📜 Historique</button>
    <a href="scan_event.html" target="_blank">📷 Scan Event</a>
  </aside>

  <!-- ===== CONTENU ===== -->
  <main>
  <!-- ======================== -->
  <!-- SECTION HOME (Statistiques) -->
  <!-- ======================== -->
  <section id="home" class="active">
    <h2 data-i18n="stats">Statistiques</h2>
    <div class="stats">
      <div class="card stat"><h3 id="totalEvents">0</h3><p data-i18n="eventsCreated">Événements créés</p></div>
      <div class="card stat"><h3 id="activeEvents">0</h3><p data-i18n="eventsActive">Événements actifs</p></div>
      <div class="card stat"><h3 id="inactiveEvents">0</h3><p data-i18n="eventsInactive">Événements inactifs</p></div>
      <div class="card stat"><h3 id="participantCredits">0</h3><p data-i18n="creditsAvailable">Crédits participants disponibles</p></div>
    </div>
  </section>

  <!-- ======================== -->
  <!-- SECTION ÉVÉNEMENTS -->
  <!-- ======================== -->
  <section id="events">
    <h2 data-i18n="manageEvents">Gestion des événements</h2>
  <!-- Onglets internes -->
  <div class="subnav">
    <button id="myEventsBtn" class="active">📋 Mes événements</button>
    <button id="addEventBtn">➕ Ajouter un événement</button>
  </div>

    <!-- Sous-section Mes événements -->
    <div id="myEventsSection" class="subsection">
      <table id="eventsTable">
        <thead>
          <tr>
            <th data-i18n="title">Titre</th>
            <th data-i18n="description">Description</th>
            <th data-i18n="date">Date</th>
            <th data-i18n="location">Lieu</th>
            <th data-i18n="price">Prix</th>
            <th>Max participants</th>
            <th>Identifiants Check-in</th>
            <th>Login Check-in</th>
            <th>Image</th>
            <th data-i18n="publicLink">Lien public</th>
            <th data-i18n="actions">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Sous-section Ajouter un événement -->
  <div id="addEventSection" class="subsection">
      <form id="addEventForm" enctype="multipart/form-data" 
            style="max-width:600px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);">

        <h2 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;color:#007bff;">
          🗓️ Ajouter un nouvel événement
        </h2>

        <!-- Infos générales -->
        <h3 style="margin:15px 0;color:#333;">Informations générales</h3>

        <label for="title">Titre de l’événement</label>
        <input type="text" id="title" placeholder="Ex: Conférence Paris 2025" class="input" required>

        <label for="description">Description</label>
        <textarea id="description" placeholder="Décrivez votre événement..." class="input"></textarea>

        <label for="date">Date</label>
        <input type="date" id="date" class="input" required>

        <label for="location">Lieu</label>
        <input type="text" id="location" placeholder="Ex: Paris, Salle X" class="input" required>

        <label for="price">Prix (€)</label>
        <input type="number" id="price" placeholder="Ex: 50" class="input" required step="0.01">

        <!-- Participants -->
        <h3 style="margin:20px 0;color:#333;">Participants</h3>

        <label for="max_participants">Nombre maximum</label>
        <input type="number" id="max_participants" placeholder="100" class="input">
        <small style="color:#666;">Par défaut fixé à <b>100 participants</b> si laissé vide.<br><br></small>

        <label for="checkin_login">Login Check-in (ScanEvent)</label>
        <input type="text" id="checkin_login" class="input">

        <label for="checkin_password">Password Check-in (ScanEvent)</label>
        <input type="password" id="checkin_password" class="input">

        <label for="image">Photo de l’événement</label>
        <input type="file" id="image" name="image" accept="image/*" class="input">

        <!-- Bouton -->
        <button type="submit" data-i18n="createEvent" 
          style="margin-top:25px;width:100%;padding:12px;background:#007bff;color:white;font-size:16px;border:none;border-radius:8px;cursor:pointer;">
          ➕ Créer l’événement
        </button>
      </form>
    </div>
  </section>
    
    <!-- ======================== -->
<!-- SECTION INSCRIPTIONS PAYÉES -->
<!-- ======================== -->
<section id="paidRegistrations">
  <h2>Liste des Inscriptions Payées ✅</h2>
  <button class="btn" onclick="exportCSV()">📂 Exporter en CSV</button>
  <table>
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Email</th>
        <th>Événement</th>
        <th>Montant (€)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="registrationsTable"></tbody>
  </table>
</section>
   
   <!-- ======================== -->
<!-- SECTION ACHETER DES CRÉDITS -->
<!-- ======================== -->
<section id="buyCredits">
  <h2>💳 Acheter des Crédits</h2>
  <p>
    Les crédits sont utilisés pour gérer vos participants aux événements.<br>
    Chaque participant validé consomme <strong>1 crédit</strong>.
  </p>

  <div class="info-box">
    <p><strong>Exemple :</strong></p>
    <ul>
      <li>50 crédits = 50 participants</li>
      <li>100 crédits = 100 participants</li>
      <li>250 crédits = 250 participants</li>
    </ul>
  </div>

  <p>Sélectionnez un pack puis procédez au paiement :</p>

  <div id="creditPacks"></div>
  <div id="paypal-button-container"></div>
<hr style="margin:24px 0">

<h3>➕ Ajouter des crédits manuellement (paiement externe)</h3>
<p style="color:#555;margin:6px 0 12px;">Utilisez ceci si vous avez encaissé un paiement <u>hors PayPal</u> (virement, cash…)</p>

<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
  <input id="manualCredits" type="number" min="1" placeholder="Nombre de crédits" style="padding:10px;width:180px;">
  <input id="manualPaymentId" type="text" placeholder="Réf. paiement (facultatif)" style="padding:10px;width:240px;">
  <button id="manualAddBtn" class="btn">Ajouter maintenant</button>
</div>

<p id="manualAddMsg" style="margin-top:10px; font-size:14px; color:#555;"></p>

</section>

<!-- ======================== -->
<!-- SECTION COMPTE PAYPAL -->
<!-- ======================== -->
<section id="paypalConfig">
  <h2>⚙️ Mon Compte PayPal</h2>
  <p id="paypalStatus" style="font-weight:bold; margin-bottom:15px; color:#333;">
    Vérification du statut PayPal...
  </p>
  <form id="paypalForm">
    <label>Client ID :</label>
    <input type="text" id="paypal_client_id" placeholder="Ton PayPal Client ID" required>

    <label>Secret :</label>
    <input type="password" id="paypal_secret" placeholder="Ton PayPal Secret" required>

    <button type="submit">💾 Enregistrer</button>
  </form>

  <button id="deletePaypalBtn" style="background:#dc3545; color:white; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; margin-top:10px; display:none;">
    ❌ Supprimer mon compte PayPal
  </button>
</section> 
    
    <!-- ======================== -->
<!-- SECTION LOGS -->
<!-- ======================== -->
<section id="logs">
  <h2>📜 Historique des actions</h2>
  <table id="logsTable">
    <thead>
      <tr>
        <th>Action</th>
        <th>Détails</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
    
    
  </main>
</div>



<!-- ======================== -->
<!-- MODALE SUPPRESSION PAYPAL -->
<!-- ======================== -->
<div id="deletePaypalModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:400px; text-align:center;">
    <h3>Confirmation de suppression</h3>
    <p>Pour supprimer ton compte PayPal, confirme ton mot de passe :</p>
    <input type="password" id="confirmPassword" placeholder="Mot de passe" style="width:100%; padding:8px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
    <br>
    <button id="confirmDeleteBtn" style="background:#dc3545; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;">❌ Supprimer</button>
    <button id="cancelDeleteBtn" style="background:#6c757d; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">Annuler</button>
  </div>
</div>






<div id="editModal">
  <div class="modal-content">
    <h3 data-i18n="editEvent">Éditer l'événement</h3>
    <form id="editEventForm" enctype="multipart/form-data">
      <input type="hidden" id="edit_id">
      <label data-i18n="title">Titre :</label><input type="text" id="edit_title" required>
      <label data-i18n="description">Description :</label><textarea id="edit_description" required></textarea>
      <label data-i18n="date">Date :</label><input type="date" id="edit_date" required>
      <label data-i18n="location">Lieu :</label><input type="text" id="edit_location" required>
      <label data-i18n="price">Prix (€) :</label><input type="number" id="edit_price" step="0.01" required>
      <label>Max participants :</label>
      <input type="number" id="edit_max_participants" placeholder="100">
      <small style="color:gray; display:block; margin-top:4px;">
        Par défaut, fixé à <b>100 participants</b> si laissé vide.
      </small>
      <label>Login Check-in :</label>
      <input type="text" id="edit_checkin_login">
      <label>Mot de passe Check-in :</label>
      <input type="password" id="edit_checkin_password">
      <label for="edit_image">Photo de l’événement</label>
      <input type="file" id="edit_image" name="edit_image" accept="image/*">
      <button type="submit" id="saveEditBtn">💾 <span data-i18n="save">Enregistrer</span></button>
      <button type="button" id="cancelEditBtn">❌ <span data-i18n="cancel">Annuler</span></button>
    </form>
  </div>
</div>

<script>
const translations = {
  fr: {
    events: "Événements", buyCredits: "Acheter des crédits", stats: "Statistiques",
    eventsCreated: "Événements créés", eventsActive: "Événements actifs", eventsInactive: "Événements inactifs", creditsAvailable: "Crédits participants disponibles",
    manageEvents: "Gestion des événements", addEvent: "Ajouter un nouvel événement", createEvent: "Créer l’événement",
    title: "Titre", description: "Description", date: "Date", location: "Lieu", price: "Prix", status: "Statut", publicLink: "Lien public", actions: "Actions",
    editEvent: "Éditer l'événement", save: "Enregistrer", cancel: "Annuler"
  },
  en: {
    events: "Events", buyCredits: "Buy credits", stats: "Statistics",
    eventsCreated: "Events created", eventsActive: "Active events", eventsInactive: "Inactive events", creditsAvailable: "Available participant credits",
    manageEvents: "Manage events", addEvent: "Add a new event", createEvent: "Create event",
    title: "Title", description: "Description", date: "Date", location: "Location", price: "Price", status: "Status", publicLink: "Public link", actions: "Actions",
    editEvent: "Edit event", save: "Save", cancel: "Cancel"
  }
};

function setLanguage(lang) {
  document.querySelectorAll("#langSelector button").forEach(btn => btn.classList.remove("active-lang"));
  document.querySelector(`#langSelector button[data-lang="${lang}"]`).classList.add("active-lang");
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = translations[lang][key];
  });
}


const eventsBtn = document.getElementById("eventsBtn");
const paypalConfigBtn = document.getElementById("paypalConfigBtn");
const logsBtn = document.getElementById("logsBtn");
const buyCreditsBtn = document.getElementById("buyCreditsBtn"); // ✅ ajouté
const paidRegistrationsBtn = document.getElementById("paidRegistrationsBtn");
const deletePaypalBtn = document.getElementById("deletePaypalBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const homeBtn   = document.getElementById("homeBtn");


// ✅ Charger infos utilisateur
async function loadUserInfo() {
  try {
    const res = await fetchWithToken("/api/me", {
      method: "POST",
      body: new URLSearchParams()
    });
    const data = await res.json();

    console.log("👤 Réponse /api/me :", data);

    if (res.ok) {
      // Nom complet
      const fullname = [data.first_name, data.last_name].filter(Boolean).join(" ");
      document.getElementById("userName").textContent = fullname || "Utilisateur";

      // Avatar si dispo
      if (data.avatar_url) {
        document.querySelectorAll(".avatar, .avatar-large").forEach(img => {
          img.src = data.avatar_url;
        });
      }
    } else {
      document.getElementById("userName").textContent = "Utilisateur";
    }
  } catch (err) {
    console.error("Erreur loadUserInfo:", err);
    document.getElementById("userName").textContent = "Utilisateur";
  }
}




// ✅ Déconnexion
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("qr4event_admin_token"); // on supprime bien le bon token
  window.location.href = "/static/login.html";
});

// ✅ Gestion crédits (packs PayPal)
let CREDIT_PACKS = {};
let selectedPack = null;
let paypalRendered = false;

async function loadConfig() {
  try {
    const res = await fetch("/api/config");
    const data = await res.json();
    if (!data.success) return console.error("Erreur config:", data.error);

    CREDIT_PACKS = data.packs;
    const container = document.getElementById("creditPacks");
    container.innerHTML = "";

    Object.entries(CREDIT_PACKS).forEach(([key, pack]) => {
      const div = document.createElement("div");
      div.className = "pack";
      div.innerHTML = `<span class="credits">${pack.credits >= 9999 ? "Illimité (1 an)" : pack.credits + " participants"}</span><span class="price">${pack.price}€</span>`;
      div.onclick = (e) => selectPack(key, e);
      container.appendChild(div);
    });

    const firstKey = Object.keys(CREDIT_PACKS)[0];
    selectedPack = CREDIT_PACKS[firstKey];
    container.querySelector(".pack").classList.add("selected");
  } catch (err) {
    console.error("Impossible de charger la config:", err);
  }
}

function selectPack(packKey, event) {
  selectedPack = CREDIT_PACKS[packKey];
  document.querySelectorAll("#creditPacks .pack").forEach(el => el.classList.remove("selected"));
  event.currentTarget.classList.add("selected");
}

// === Ajouter des crédits manuels (utilise /admin/credits/add) ===
function setupManualCreditAdder(){
  const btn = document.getElementById('manualAddBtn');
  if (!btn || btn._wired) return;  // évite un double-binding si on revient sur l’onglet
  btn._wired = true;

  btn.addEventListener('click', async () => {
    const msg = document.getElementById('manualAddMsg');
    const credits = parseInt(document.getElementById('manualCredits').value || '0', 10);
    const payment_id = (document.getElementById('manualPaymentId').value || '').trim();

    if (!credits || credits <= 0) {
      msg.textContent = '⚠️ Indique un nombre de crédits > 0.';
      return;
    }

    msg.textContent = 'Ajout en cours…';

    try {
      const res = await fetchWithToken('/admin/credits/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ credits, payment_id }) // pas besoin d'ajouter token, le wrapper le fait
      });
      const data = await res.json();

      if (!data.success) {
        msg.textContent = '❌ ' + (data.message || 'Erreur lors de l’ajout.');
        return;
      }

      msg.textContent = `✅ Crédits ajoutés. Nouveau solde: ${data.new_credits}`;

      // Mets à jour le compteur des stats à l’écran
      const bal = document.getElementById('participantCredits');
      if (bal) bal.textContent = data.new_credits;

await refreshCredits();

      // (optionnel) rafraîchir toute la liste/stats :
      // await loadEvents();

      // reset inputs
      document.getElementById('manualCredits').value = '';
      document.getElementById('manualPaymentId').value = '';

    } catch (e) {
      console.error(e);
      msg.textContent = '❌ Erreur réseau.';
    }
  });
}

// Rafraîchir le compteur "Crédits participants disponibles"
async function refreshCredits() {
  try {
    const res = await fetch('/api/license/credits');
    const data = await res.json();
    const el = document.getElementById('participantCredits');
    if (el && typeof data.remaining_participant_credits === 'number') {
      el.textContent = data.remaining_participant_credits;
    }
  } catch (e) {
    console.warn('refreshCredits() a échoué:', e);
  }
}

// ✅ Charger événements et stats
async function loadEvents() {
  try {
    const res = await fetchWithToken("/admin/events/list", {
      method: "POST",
      body: new URLSearchParams()
    });

    if (!res.ok) {
      throw new Error(`HTTP ${res.status} ${res.statusText}`);
    }

    let data;
    try {
      data = await res.json();
    } catch (e) {
      throw new Error("Réponse backend non-JSON");
    }

    console.log("📦 /admin/events/list →", data);

    if (!data || data.success === false) {
      const msg = data?.message || data?.error || "Backend a renvoyé success:false";
      throw new Error(msg);
    }

    const events = Array.isArray(data.events) ? data.events : [];

    // --- KPIs ---
    document.getElementById("totalEvents").textContent    = events.length;
    document.getElementById("activeEvents").textContent   = events.filter(e => !!e.is_active).length;
    document.getElementById("inactiveEvents").textContent = events.filter(e => !e.is_active).length;
    document.getElementById("participantCredits").textContent = data.participant_credits ?? 0;

    // --- Table ---
    const tbody = document.querySelector("#eventsTable tbody");
    tbody.innerHTML = "";

    const safe   = v => (v ?? "");
    const asText = v => String(v ?? "");

    events.forEach(ev => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${safe(ev.title)}</td>
        <td>${safe(ev.description)}</td>
        <td>${safe(ev.date)}</td>
        <td>${safe(ev.location)}</td>
        <td>${ev.price != null ? asText(ev.price) + " €" : "—"}</td>
        <td>${ev.max_participants ?? "∞"}</td>

        <td>
          <b>Login :</b> ${safe(ev.checkin_login) || "—"}<br>
          <b>Pass :</b> <span class="pass" id="pass-${ev.id}">••••••</span>
          <button class="btn-showpass" data-id="${ev.id}">👁️</button>
        </td>

        <td>${safe(ev.checkin_login) || "—"}</td>

        <td>
          ${ev.image_url
            ? `<img src="${safe(ev.image_url)}" style="max-height:50px;border-radius:6px;">`
            : "—"}
        </td>

        <td>
          <a href="${safe(ev.public_url) || ("/static/event.html?id=" + ev.id)}" target="_blank" rel="noopener">
            <button class="action-btn link-btn">🔗 Voir</button>
          </a>
        </td>

        <td>
          <button class="btn btn-primary btn-edit"  data-id="${ev.id}">✏️ Modifier</button>
          <button class="btn btn-danger  btn-del"   data-id="${ev.id}">🗑️ Supprimer</button>
          <button class="btn btn-warning btn-toggle" data-id="${ev.id}">
            ${ev.is_active ? "⏸️ Désactiver" : "▶ Activer"}
          </button>
        </td>
      `;
      tbody.appendChild(row);

      // branchements sans inline JS
      row.querySelector(".btn-edit")   ?.addEventListener("click", () => openEditModal(ev.id));
      row.querySelector(".btn-del")    ?.addEventListener("click", () => deleteEvent(ev.id));
      row.querySelector(".btn-toggle") ?.addEventListener("click", () => toggleEvent(ev.id));
      row.querySelector(".btn-showpass")?.addEventListener("click", () => {
        const el = document.getElementById("pass-" + ev.id);
        if (!el) return;
        const real = ev.checkin_password ?? "";
        el.textContent = el.textContent.includes("•") ? real : "••••••";
      });
    });

  } catch (err) {
    console.error("loadEvents() →", err);
    alert("Erreur événements : " + err.message);
  }
}

// ✅ Charger les inscriptions payées
async function loadPaidRegistrations() {
  const res = await fetchWithToken("/admin/paid-registrations", {
    method: "POST",
    body: new URLSearchParams()
  });
  const data = await res.json();
  if (!data.success) {
    alert(data.error || "Erreur de chargement");
    return;
  }

  const tbody = document.getElementById("registrationsTable");
  tbody.innerHTML = "";
  data.registrations.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.nom}</td>
      <td>${r.prenom}</td>
      <td>${r.email}</td>
      <td>${r.evenement}</td>
      <td>${r.montant} €</td>
      <td>${r.date}</td>
    `;
    tbody.appendChild(row);
  });
}

// ✅ Export CSV
async function exportCSV() {
  const response = await fetchWithToken("/admin/paid-registrations/csv", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams()
  });

  if (!response.ok) {
    alert("Erreur lors de l’export CSV");
    return;
  }

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "inscriptions.csv";
  a.click();

  window.URL.revokeObjectURL(url);
}

// ✅ Gestion édition / suppression
function openEditModal(id) {
  fetch(`/api/event/${id}`)
    .then(r => r.json())
    .then(data => {
      const ev = data.event || data;

      document.getElementById("edit_id").value = ev.id;
      document.getElementById("edit_title").value = ev.title || "";
      document.getElementById("edit_description").value = ev.description || "";
      document.getElementById("edit_date").value = ev.date || "";
      document.getElementById("edit_location").value = ev.location || "";
      document.getElementById("edit_price").value = ev.price || 0;
      document.getElementById("edit_max_participants").value = ev.max_participants || 100;
      document.getElementById("edit_checkin_login").value = ev.checkin_login || "";
      document.getElementById("edit_checkin_password").value = ev.checkin_password || "";

      document.getElementById("editModal").style.display = "flex";
    })
    .catch(err => {
      alert("❌ Impossible de charger l’événement : " + err.message);
    });
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}
document.getElementById("cancelEditBtn").addEventListener("click", closeEditModal);


async function deleteEvent(id) {
  if (!confirm("Supprimer l’événement ?")) return;
  const form = new URLSearchParams();
  form.append("event_id", id);

  const res = await fetchWithToken("/admin/events/delete", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur suppression : " + (data.error || ""));
}


async function toggleEvent(id) {
  const form = new URLSearchParams();
  form.append("event_id", id);

  const res = await fetchWithToken("/admin/events/toggle", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur activation/désactivation : " + (data.error || ""));
}

// ========================
// Navigation entre sections
// ========================
function showSection(id) {
  // Masquer toutes les sections
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));

  // Afficher uniquement la section choisie
  document.getElementById(id).classList.add("active");

  // Réinitialiser l'état des boutons
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));

  // Activer le bouton correspondant
  if (id === "events") eventsBtn.classList.add("active");
  if (id === "paypalConfig") paypalConfigBtn.classList.add("active");
  if (id === "logs") logsBtn.classList.add("active");
  if (id === "buyCredits") buyCreditsBtn.classList.add("active");
  if (id === "paidRegistrations") paidRegistrationsBtn.classList.add("active");
  if (id === "home") homeBtn.classList.add("active");

}

// ⚡ Brancher les boutons
eventsBtn.addEventListener("click", () => showSection("events"));
paypalConfigBtn.addEventListener("click", () => { showSection("paypalConfig"); loadPaypalStatus(); });
logsBtn.addEventListener("click", () => { showSection("logs"); loadLogs(); });
buyCreditsBtn.addEventListener("click", () => { showSection("buyCredits"); loadConfig(); setupManualCreditAdder(); refreshCredits(); });
paidRegistrationsBtn.addEventListener("click", () => { 
  showSection("paidRegistrations"); 
  loadPaidRegistrations(); 
});

// ========================
// Vérifier statut PayPal
// ========================
async function loadPaypalStatus() {

  const res = await fetchWithToken("/admin/paypal/status", { method: "POST", body: new URLSearchParams() });
  const data = await res.json();

  const statusEl = document.getElementById("paypalStatus");
  const deleteBtn = document.getElementById("deletePaypalBtn");

  if (data.success && data.configured) {
    statusEl.innerHTML = `✅ Compte PayPal configuré<br><small>Client ID : ${data.client_id.substring(0,8)}... </small>`;
    statusEl.style.color = "green";
    deleteBtn.style.display = "inline-block";
  } else {
    statusEl.innerHTML = "❌ Aucun compte PayPal configuré";
    statusEl.style.color = "red";
    deleteBtn.style.display = "none";
  }
}

// ========================
// Sauvegarde des identifiants PayPal
// ========================
document.getElementById("paypalForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new URLSearchParams();
  form.append("client_id", document.getElementById("paypal_client_id").value);
  form.append("secret", document.getElementById("paypal_secret").value);

  const res = await fetchWithToken("/admin/paypal/set", { method: "POST", body: form });
  const data = await res.json();

  if (data.success) {
    alert("✅ Compte PayPal enregistré avec succès !");
    document.getElementById("paypalForm").reset();
    loadPaypalStatus();
  } else {
    alert("❌ Erreur : " + (data.error || "Impossible d’enregistrer"));
  }
});


// ✅ Sauvegarde modification (avec upload image)
document.getElementById("editEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const editForm = new FormData();
  editForm.append("event_id", document.getElementById("edit_id").value);
  editForm.append("title", document.getElementById("edit_title").value);
  editForm.append("description", document.getElementById("edit_description").value);
  editForm.append("date", document.getElementById("edit_date").value);
  editForm.append("location", document.getElementById("edit_location").value);
  editForm.append("price", document.getElementById("edit_price").value);
  editForm.append("max_participants", document.getElementById("edit_max_participants").value);
  editForm.append("checkin_login", document.getElementById("edit_checkin_login").value);
  editForm.append("checkin_password", document.getElementById("edit_checkin_password").value);

  // ✅ Ajout de l’image si un nouveau fichier est choisi
  const editImageFile = document.getElementById("edit_image").files[0];
  if (editImageFile) {
    editForm.append("image", editImageFile);
  }

  const res = await fetchWithToken("/admin/events/update", {
    method: "POST",
    body: editForm
  });
  const data = await res.json();
  if (data.success) {
    alert("✅ Événement modifié");
    document.getElementById("editModal").style.display = "none";
    loadEvents();
  } else {
    alert("❌ Erreur modification : " + (data.error || "")); 
  }
});

// ========================
// Suppression PayPal sécurisée
// ========================
const modal = document.getElementById("deletePaypalModal");
deletePaypalBtn.addEventListener("click", () => modal.style.display = "flex");
cancelDeleteBtn.addEventListener("click", () => { 
  modal.style.display = "none"; 
  document.getElementById("confirmPassword").value = ""; 
});

confirmDeleteBtn.addEventListener("click", async () => {
  const password = document.getElementById("confirmPassword").value;
  if (!password) return alert("⚠️ Merci de saisir ton mot de passe");

  const form = new URLSearchParams();
  form.append("password", password);

  const res = await fetchWithToken("/admin/paypal/delete", { method: "POST", body: form });
  const data = await res.json();

  if (data.success) {
    alert("✅ " + data.message);
    loadPaypalStatus();
    modal.style.display = "none";
    document.getElementById("confirmPassword").value = "";
  } else {
    alert("❌ Erreur : " + (data.error || ""));
  }
});

// ========================
// Charger les logs admin
// ========================
async function loadLogs() {

  const res = await fetchWithToken("/admin/logs", { method: "POST", body: new URLSearchParams() });
  const data = await res.json();

  const tbody = document.querySelector("#logsTable tbody");
  tbody.innerHTML = "";

  if (data.success) {
    if (data.logs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3">Aucune action enregistrée</td></tr>`;
      return;
    }

data.logs.forEach(log => {
  const row = document.createElement("tr");

  let color = "#333"; // par défaut noir
  let icon = "ℹ️";

  // 🚫 Si c’est un refus webhook → rouge
  if (log.action.includes("WEBHOOK_REFUSED")) {
    color = "red";
    icon = "🚫";
  }
  // ⚠️ Si c’est une suppression sensible (PayPal par ex.)
  else if (log.action.includes("DELETE_PAYPAL")) {
    color = "orange";
    icon = "⚠️";
  }

  row.innerHTML = `
    <td><b style="color:${color}">${icon} ${log.action}</b></td>
    <td>${log.details || ""}</td>
    <td>${log.date}</td>
  `;
  tbody.appendChild(row);
});

  } else {
    alert("❌ Erreur chargement logs : " + (data.error || ""));
  }
}

// ✅ Création d’un nouvel événement
document.getElementById("addEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new FormData();
  form.append("title", document.getElementById("title").value);
  form.append("description", document.getElementById("description").value);
  form.append("date", document.getElementById("date").value);
  form.append("location", document.getElementById("location").value);
  form.append("price", document.getElementById("price").value);
  form.append("max_participants", document.getElementById("max_participants").value);
  form.append("checkin_login", document.getElementById("checkin_login").value);
  form.append("checkin_password", document.getElementById("checkin_password").value);

  // ✅ Ajout de l'image si un fichier est choisi
  const imageFile = document.getElementById("image").files[0];
  if (imageFile) {
    form.append("image", imageFile);
  }

  const res = await fetchWithToken("/admin/events", {
    method: "POST",
    body: form
  });
  const data = await res.json();

  if (data.success) {
    alert("✅ Événement créé !");
    document.getElementById("addEventForm").reset();
    loadEvents(); // rafraîchit la liste et les stats
  } else {
    alert("❌ Erreur création : " + (data.error || "Impossible de créer l’événement"));
  }
});

// ========================
// ⏰ Déconnexion auto après 15 min d’inactivité
// ========================
let inactivityTimer;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    localStorage.removeItem("qr4event_admin_token");

    // ➕ Stocker la raison
    sessionStorage.setItem("logoutReason", "Vous avez été déconnecté pour cause d'inactivité.");

    // Redirection
    window.location.href = "/static/login.html";
  }, 900000); // en ms = 15 min
}

["mousemove", "keydown", "click", "scroll"].forEach(evt => {
  window.addEventListener(evt, resetInactivityTimer);
});
resetInactivityTimer();

</script>
<script>
function renderPayPalButton() {
  if (!window.paypal) {
    console.error("SDK PayPal non chargé !");
    return;
  }

  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: selectedPack ? selectedPack.price : '149.00' // 💶 montant dynamique ou valeur par défaut
          }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        console.log("✅ Paiement validé :", details);
        // Redirection vers page succès
        window.location.href = "/static/success.html?orderId=" + data.orderID;
      });
    },
    onCancel: function (data) {
      window.location.href = "/static/cancel.html";
    },
    onError: function (err) {
      console.error("❌ Erreur PayPal :", err);
      window.location.href = "/static/error.html";
    }
  }).render('#paypal-button-container');
}

// ⚡ Attendre que le SDK soit chargé avant de lancer le bouton
const checkPaypal = setInterval(() => {
  if (window.paypal) {
    clearInterval(checkPaypal);
    renderPayPalButton();
  }
}, 500);
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
    // Navigation principale
homeBtn.addEventListener("click", () => showSection("home"));
eventsBtn.addEventListener("click", () => showSection("events"));

// Navigation sous-sections Événements
const myEventsBtn = document.getElementById("myEventsBtn");
const addEventBtn = document.getElementById("addEventBtn");

myEventsBtn.addEventListener("click", () => {
  document.querySelectorAll("#events .subsection").forEach(s => s.classList.remove("active"));
  document.getElementById("myEventsSection").classList.add("active");
  myEventsBtn.classList.add("active");
  addEventBtn.classList.remove("active");
});

addEventBtn.addEventListener("click", () => {
  document.querySelectorAll("#events .subsection").forEach(s => s.classList.remove("active"));
  document.getElementById("addEventSection").classList.add("active");
  addEventBtn.classList.add("active");
  myEventsBtn.classList.remove("active");
});

  loadEvents();
  loadUserInfo();
});

</script>


</body>
</html>
