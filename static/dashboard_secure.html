<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin</title>
  <script>
    async function loadPayPalSdk() {
      const res = await fetch("/api/paypal-client-id");
      const data = await res.json();
      if (data.client_id) {
        const script = document.createElement("script");
        script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR`;
        script.async = true;
        document.head.appendChild(script);
      } else {
        console.error("Erreur PayPal:", data.error || "client_id manquant");
      }
    }
    loadPayPalSdk();
  </script>

<!-- ‚úÖ cache-busting pour √©viter une vieille version -->
<script src="/static/js/admin-token.js?v=2025-09-05" defer></script>

  <style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6fa;
  margin: 0;
  padding: 0;
  padding-top: 180px;  /* espace pour compenser header + nav */
 box-sizing: border-box;
}
header {
  background: #007bff;
  color: white;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;     /* fige le header */
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;       /* toujours au-dessus */
box-sizing: border-box; /* √©vite d√©bordements */
}
nav {
  background: #e9ecef;
  padding: 10px;
  display: flex;
  justify-content: center;
  gap: 20px;
  position: fixed;    /* fige la barre grise */
  top: 120px;         /* se place juste sous le header bleu */
  left: 0;
  width: 100%;
  z-index: 999;
box-sizing: border-box;
}
    nav button { padding: 10px 15px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
    nav button.active { background: #0056b3; }
    #logoutBtn { background: red; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
table {
  width: 100%;
  border-collapse: separate;  /* permet le border-radius */
  border-spacing: 0;          /* colle les cellules */
  margin-top: 20px;
  overflow: hidden;
  border-radius: 12px;        /* arrondi */
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* ombre l√©g√®re */
}

th, td {
  padding: 12px 15px;
  border: 1px solid #ddd;
  text-align: left;
}

th {
  background: #007bff;
  color: white;
}

tbody tr:nth-child(even) {
  background: #f9f9f9;  /* alternance des lignes */
}

tbody tr:hover {
  background: #eef6ff;  /* effet survol */
}

    .action-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
    .edit-btn { background: #ffc107; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .toggle-btn { background: #17a2b8; color: white; }
    .link-btn { background: #28a745; color: white; }
    form#addEventForm { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    form#addEventForm input, form#addEventForm textarea { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 5px; }
    form#addEventForm button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    form#addEventForm button:hover { background: #0056b3; }
    #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #editModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:400px; }
    #editModal input, #editModal textarea { width:100%; margin:6px 0; padding:8px; border:1px solid #ccc; border-radius:5px; }
    #editModal button { margin-top:10px; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; }
    #saveEditBtn { background:#28a745; color:white; }
    #cancelEditBtn { background:#dc3545; color:white; }
    .stats { display: flex; gap: 20px; margin: 20px 0; }
    .stat { background: white; padding: 20px; border-radius: 10px; flex: 1; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .stat h3 { font-size: 24px; margin: 0; }
    #langSelector button { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; margin: 0 2px; }
    #langSelector button.active-lang { background: #0056b3; color: white; font-weight: bold; border: 1px solid #003f7f; }
    #creditPacks { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
    #creditPacks .pack { border: 2px solid #ddd; border-radius: 8px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s ease; font-size: 15px; background: #f9f9f9; }
    #creditPacks .pack:hover { border-color: #007bff; background: #eef6ff; transform: translateY(-2px); }
    #creditPacks .pack.selected { border-color: #007bff; background: #dceeff; font-weight: bold; }
    #creditPacks .credits { color: #333; }
    #creditPacks .price { color: #007bff; font-weight: bold; }

#creditPacks .price { 
  color: #007bff; 
  font-weight: bold; 
}

/* ‚úÖ Fix affichage popup PayPal */
#paypalModal {
  z-index: 9998 !important;   /* au-dessus de la nav et du header */
}

#paypal-button-container iframe,
iframe[src*="paypal.com"] {
  z-index: 9999 !important;   /* forcer PayPal au-dessus */
  position: relative !important;
}
/* ‚úÖ Style pour le bouton Export CSV */
.btn {
  background: #007bff;   /* bleu vif */
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 15px;
  font-size: 15px;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  gap: 8px;  /* espace entre l‚Äôemoji et le texte */
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: all 0.2s ease-in-out;
}

.btn:hover {
  background: #0056b3; /* bleu fonc√© au survol */
  transform: translateY(-2px); /* petit effet flottant */
}
/* ‚úÖ Forcer la modale √† passer au-dessus du header/nav */
#editModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;   /* centre verticalement */
  z-index: 2000;
  padding: 20px;
  box-sizing: border-box;
}

#editModal .modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;              /* s‚Äôadapte mieux aux petits √©crans */
  max-width: 500px;        /* limite sur grands √©crans */
  max-height: 80vh;        /* pas plus de 80% de la hauteur visible */
  overflow-y: auto;        /* scroll interne si √ßa d√©passe */
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}


  </style>
</head>
<body>
<header>
  <h1 id="headerTitle">Dashboard Admin</h1>
<div style="position:absolute; left:50%; transform:translateX(-50%); 
            background:white; padding:10px; border-radius:12px; 
            box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <img src="/static/img/qrevent-logo.png" 
       alt="Logo QR EVENT" 
       style="height:80px; width:auto; display:block;">
</div>
  <div style="text-align:right; font-size:14px;">
    <div><b id="connectedAs">Connect√© en tant que : </b><span id="userEmail"></span></div>
  <button id="logoutBtn" style="
    background: red;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 6px;
    display: inline-block;
  ">
    D√©connexion
  </button>
    <div id="langSelector" style="margin-top:8px;">
      <button data-lang="fr" onclick="setLanguage('fr')">FR</button>
      <button data-lang="en" onclick="setLanguage('en')">EN</button>
    </div>
  </div>
</header>

<!-- BARRE DE NAVIGATION GRISE -->
<nav>
  <!-- 1. √âv√©nements -->
  <button id="eventsBtn" class="active" data-i18n="events">√âv√©nements</button>

  <!-- 2. Inscriptions Pay√©es -->
  <button id="paidRegistrationsBtn">üìã Inscriptions Pay√©es</button>

  <!-- 3. Acheter des cr√©dits -->
  <button id="buyCreditsBtn" data-i18n="buyCredits">Acheter des cr√©dits</button>

  <!-- 4. Mon PayPal -->
  <button id="paypalConfigBtn">‚öôÔ∏è Mon PayPal</button>

  <!-- 5. Historique -->
  <button id="logsBtn">üìú Historique</button>

  <!-- Logo ScanEvent comme bouton ouvrant une nouvelle fen√™tre -->
  <a href="scan_event.html" target="_blank" rel="noopener">

    <img src="/static/img/scanevent-logo.png" 
         alt="Scan Event" 
         style="height:65px; width:auto; margin-left:20px; cursor:pointer; padding:5px; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
  </a>
</nav>


<section id="events" class="active">
  <h2 data-i18n="stats">Statistiques</h2>
  <div class="stats">
    <div class="card stat"><h3 id="totalEvents">0</h3><p data-i18n="eventsCreated">√âv√©nements cr√©√©s</p></div>
    <div class="card stat"><h3 id="activeEvents">0</h3><p data-i18n="eventsActive">√âv√©nements actifs</p></div>
    <div class="card stat"><h3 id="inactiveEvents">0</h3><p data-i18n="eventsInactive">√âv√©nements inactifs</p></div>
    <div class="card stat"><h3 id="participantCredits">0</h3><p data-i18n="creditsAvailable">Cr√©dits participants disponibles</p></div>
  </div>
  <h2 data-i18n="manageEvents">Gestion des √©v√©nements</h2>

<form id="addEventForm" enctype="multipart/form-data" 
      style="max-width:600px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);">


  <h2 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;color:#007bff;">
    üóìÔ∏è Ajouter un nouvel √©v√©nement
  </h2>

  <!-- Infos g√©n√©rales -->
  <h3 style="margin:15px 0;color:#333;">Informations g√©n√©rales</h3>

  <label for="title">Titre de l‚Äô√©v√©nement</label>
  <input type="text" id="title" placeholder="Ex: Conf√©rence Paris 2025" class="input" required>

  <label for="description">Description</label>
  <textarea id="description" placeholder="D√©crivez votre √©v√©nement..." class="input"></textarea>

  <label for="date">Date</label>
  <input type="date" id="date" class="input" required>

  <label for="location">Lieu</label>
  <input type="text" id="location" placeholder="Ex: Paris, Salle X" class="input" required>

  <label for="price">Prix (‚Ç¨)</label>
  <input type="number" id="price" placeholder="Ex: 50" class="input" required step="0.01">

  <!-- Participants -->
  <h3 style="margin:20px 0;color:#333;">Participants</h3>

  <label for="max_participants">Nombre maximum</label>
  <input type="number" id="max_participants" placeholder="100" class="input">
  <small style="color:#666;">Par d√©faut fix√© √† <b>100 participants</b> si laiss√© vide.<br><br></small>

  <label for="checkin_login">Login Check-in (ScanEvent)</label>
  <input type="text" id="checkin_login" class="input">

  <label for="checkin_password">Password Check-in (ScanEvent)</label>
  <input type="password" id="checkin_password" class="input">

<label for="image">Photo de l‚Äô√©v√©nement</label>
<input type="file" id="image" name="image" accept="image/*" class="input">

  <!-- Bouton -->
  <button type="submit" data-i18n="createEvent" 
    style="margin-top:25px;width:100%;padding:12px;background:#007bff;color:white;font-size:16px;border:none;border-radius:8px;cursor:pointer;">
    ‚ûï Cr√©er l‚Äô√©v√©nement
  </button>
</form>

<style>
  .input {
    width:100%;
    padding:10px;
    margin:8px 0 15px;
    border:1px solid #ccc;
    border-radius:6px;
    font-size:14px;
    box-sizing: border-box;
  }
  .input:focus {
    outline:none;
    border-color:#007bff;
    box-shadow:0 0 4px rgba(0,123,255,0.3);
  }
</style>


  <table id="eventsTable">
    <thead>
      <tr>
        <th data-i18n="title">Titre</th>
        <th data-i18n="description">Description</th>
        <th data-i18n="date">Date</th>
        <th data-i18n="location">Lieu</th>
        <th data-i18n="price">Prix</th>
        <th>Max participants</th>
        <th>Identifiants Check-in</th>
        <th>Login Check-in</th>
        <th>Image</th>
        <th data-i18n="publicLink">Lien public</th>
        <th data-i18n="actions">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- ======================== -->
<!-- SECTION INSCRIPTIONS PAY√âES -->
<!-- ======================== -->
<section id="paidRegistrations">
  <h2>Liste des Inscriptions Pay√©es ‚úÖ</h2>
  <button class="btn" onclick="exportCSV()">üìÇ Exporter en CSV</button>
  <table>
    <thead>
      <tr>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Email</th>
        <th>√âv√©nement</th>
        <th>Montant (‚Ç¨)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="registrationsTable"></tbody>
  </table>
</section>


<!-- ======================== -->
<!-- SECTION COMPTE PAYPAL -->
<!-- ======================== -->
<section id="paypalConfig">
  <h2>‚öôÔ∏è Mon Compte PayPal</h2>
  <p id="paypalStatus" style="font-weight:bold; margin-bottom:15px; color:#333;">
    V√©rification du statut PayPal...
  </p>
  <form id="paypalForm">
    <label>Client ID :</label>
    <input type="text" id="paypal_client_id" placeholder="Ton PayPal Client ID" required>

    <label>Secret :</label>
    <input type="password" id="paypal_secret" placeholder="Ton PayPal Secret" required>

    <button type="submit">üíæ Enregistrer</button>
  </form>

  <button id="deletePaypalBtn" style="background:#dc3545; color:white; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; margin-top:10px; display:none;">
    ‚ùå Supprimer mon compte PayPal
  </button>
</section>

<!-- ======================== -->
<!-- MODALE SUPPRESSION PAYPAL -->
<!-- ======================== -->
<div id="deletePaypalModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:400px; text-align:center;">
    <h3>Confirmation de suppression</h3>
    <p>Pour supprimer ton compte PayPal, confirme ton mot de passe :</p>
    <input type="password" id="confirmPassword" placeholder="Mot de passe" style="width:100%; padding:8px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
    <br>
    <button id="confirmDeleteBtn" style="background:#dc3545; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;">‚ùå Supprimer</button>
    <button id="cancelDeleteBtn" style="background:#6c757d; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">Annuler</button>
  </div>
</div>

<!-- ======================== -->
<!-- SECTION LOGS -->
<!-- ======================== -->
<section id="logs">
  <h2>üìú Historique des actions</h2>
  <table id="logsTable">
    <thead>
      <tr>
        <th>Action</th>
        <th>D√©tails</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- ======================== -->
<!-- SECTION ACHETER DES CR√âDITS -->
<!-- ======================== -->
<section id="buyCredits">
  <h2>üí≥ Acheter des Cr√©dits</h2>
  <p>
    Les cr√©dits sont utilis√©s pour g√©rer vos participants aux √©v√©nements.<br>
    Chaque participant valid√© consomme <strong>1 cr√©dit</strong>.
  </p>

  <div class="info-box">
    <p><strong>Exemple :</strong></p>
    <ul>
      <li>50 cr√©dits = 50 participants</li>
      <li>100 cr√©dits = 100 participants</li>
      <li>250 cr√©dits = 250 participants</li>
    </ul>
  </div>

  <p>S√©lectionnez un pack puis proc√©dez au paiement :</p>

  <div id="creditPacks"></div>
  <div id="paypal-button-container"></div>
<hr style="margin:24px 0">

<h3>‚ûï Ajouter des cr√©dits manuellement (paiement externe)</h3>
<p style="color:#555;margin:6px 0 12px;">Utilisez ceci si vous avez encaiss√© un paiement <u>hors PayPal</u> (virement, cash‚Ä¶)</p>

<div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
  <input id="manualCredits" type="number" min="1" placeholder="Nombre de cr√©dits" style="padding:10px;width:180px;">
  <input id="manualPaymentId" type="text" placeholder="R√©f. paiement (facultatif)" style="padding:10px;width:240px;">
  <button id="manualAddBtn" class="btn">Ajouter maintenant</button>
</div>

<p id="manualAddMsg" style="margin-top:10px; font-size:14px; color:#555;"></p>

</section>


<div id="editModal">
  <div class="modal-content">
    <h3 data-i18n="editEvent">√âditer l'√©v√©nement</h3>
    <form id="editEventForm" enctype="multipart/form-data">
      <input type="hidden" id="edit_id">
      <label data-i18n="title">Titre :</label><input type="text" id="edit_title" required>
      <label data-i18n="description">Description :</label><textarea id="edit_description" required></textarea>
      <label data-i18n="date">Date :</label><input type="date" id="edit_date" required>
      <label data-i18n="location">Lieu :</label><input type="text" id="edit_location" required>
      <label data-i18n="price">Prix (‚Ç¨) :</label><input type="number" id="edit_price" step="0.01" required>
      <label>Max participants :</label>
      <input type="number" id="edit_max_participants" placeholder="100">
      <small style="color:gray; display:block; margin-top:4px;">
        Par d√©faut, fix√© √† <b>100 participants</b> si laiss√© vide.
      </small>
      <label>Login Check-in :</label>
      <input type="text" id="edit_checkin_login">
      <label>Mot de passe Check-in :</label>
      <input type="password" id="edit_checkin_password">
      <label for="edit_image">Photo de l‚Äô√©v√©nement</label>
      <input type="file" id="edit_image" name="edit_image" accept="image/*">
      <button type="submit" id="saveEditBtn">üíæ <span data-i18n="save">Enregistrer</span></button>
      <button type="button" id="cancelEditBtn">‚ùå <span data-i18n="cancel">Annuler</span></button>
    </form>
  </div>
</div>

<script>
const translations = {
  fr: {
    events: "√âv√©nements", buyCredits: "Acheter des cr√©dits", stats: "Statistiques",
    eventsCreated: "√âv√©nements cr√©√©s", eventsActive: "√âv√©nements actifs", eventsInactive: "√âv√©nements inactifs", creditsAvailable: "Cr√©dits participants disponibles",
    manageEvents: "Gestion des √©v√©nements", addEvent: "Ajouter un nouvel √©v√©nement", createEvent: "Cr√©er l‚Äô√©v√©nement",
    title: "Titre", description: "Description", date: "Date", location: "Lieu", price: "Prix", status: "Statut", publicLink: "Lien public", actions: "Actions",
    editEvent: "√âditer l'√©v√©nement", save: "Enregistrer", cancel: "Annuler"
  },
  en: {
    events: "Events", buyCredits: "Buy credits", stats: "Statistics",
    eventsCreated: "Events created", eventsActive: "Active events", eventsInactive: "Inactive events", creditsAvailable: "Available participant credits",
    manageEvents: "Manage events", addEvent: "Add a new event", createEvent: "Create event",
    title: "Title", description: "Description", date: "Date", location: "Location", price: "Price", status: "Status", publicLink: "Public link", actions: "Actions",
    editEvent: "Edit event", save: "Save", cancel: "Cancel"
  }
};

function setLanguage(lang) {
  document.querySelectorAll("#langSelector button").forEach(btn => btn.classList.remove("active-lang"));
  document.querySelector(`#langSelector button[data-lang="${lang}"]`).classList.add("active-lang");
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = translations[lang][key];
  });
}


const eventsBtn = document.getElementById("eventsBtn");
const paypalConfigBtn = document.getElementById("paypalConfigBtn");
const logsBtn = document.getElementById("logsBtn");
const buyCreditsBtn = document.getElementById("buyCreditsBtn"); // ‚úÖ ajout√©
const paidRegistrationsBtn = document.getElementById("paidRegistrationsBtn");
const deletePaypalBtn = document.getElementById("deletePaypalBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");


// ‚úÖ Charger infos utilisateur
async function loadUserInfo() {
  const res = await fetchWithToken("/me", { method: "POST", body: new URLSearchParams() });
  const data = await res.json();

console.log("üë§ R√©ponse /me :", data);  // <-- DEBUG

  document.getElementById("userEmail").textContent =
  (data && data.success && data.email) ? data.email : "Session expir√©e";

}

// ‚úÖ D√©connexion
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("admin_token"); // on supprime bien le bon token
  window.location.href = "/static/login.html";
});

// ‚úÖ Gestion cr√©dits (packs PayPal)
let CREDIT_PACKS = {};
let selectedPack = null;
let paypalRendered = false;

async function loadConfig() {
  try {
    const res = await fetch("/api/config");
    const data = await res.json();
    if (!data.success) return console.error("Erreur config:", data.error);

    CREDIT_PACKS = data.packs;
    const container = document.getElementById("creditPacks");
    container.innerHTML = "";

    Object.entries(CREDIT_PACKS).forEach(([key, pack]) => {
      const div = document.createElement("div");
      div.className = "pack";
      div.innerHTML = `<span class="credits">${pack.credits >= 9999 ? "Illimit√© (1 an)" : pack.credits + " participants"}</span><span class="price">${pack.price}‚Ç¨</span>`;
      div.onclick = (e) => selectPack(key, e);
      container.appendChild(div);
    });

    const firstKey = Object.keys(CREDIT_PACKS)[0];
    selectedPack = CREDIT_PACKS[firstKey];
    container.querySelector(".pack").classList.add("selected");
  } catch (err) {
    console.error("Impossible de charger la config:", err);
  }
}

function selectPack(packKey, event) {
  selectedPack = CREDIT_PACKS[packKey];
  document.querySelectorAll("#creditPacks .pack").forEach(el => el.classList.remove("selected"));
  event.currentTarget.classList.add("selected");
}

// === Ajouter des cr√©dits manuels (utilise /admin/credits/add) ===
function setupManualCreditAdder(){
  const btn = document.getElementById('manualAddBtn');
  if (!btn || btn._wired) return;  // √©vite un double-binding si on revient sur l‚Äôonglet
  btn._wired = true;

  btn.addEventListener('click', async () => {
    const msg = document.getElementById('manualAddMsg');
    const credits = parseInt(document.getElementById('manualCredits').value || '0', 10);
    const payment_id = (document.getElementById('manualPaymentId').value || '').trim();

    if (!credits || credits <= 0) {
      msg.textContent = '‚ö†Ô∏è Indique un nombre de cr√©dits > 0.';
      return;
    }

    msg.textContent = 'Ajout en cours‚Ä¶';

    try {
      const res = await fetchWithToken('/admin/credits/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ credits, payment_id }) // pas besoin d'ajouter token, le wrapper le fait
      });
      const data = await res.json();

      if (!data.success) {
        msg.textContent = '‚ùå ' + (data.message || 'Erreur lors de l‚Äôajout.');
        return;
      }

      msg.textContent = `‚úÖ Cr√©dits ajout√©s. Nouveau solde: ${data.new_credits}`;

      // Mets √† jour le compteur des stats √† l‚Äô√©cran
      const bal = document.getElementById('participantCredits');
      if (bal) bal.textContent = data.new_credits;

await refreshCredits();

      // (optionnel) rafra√Æchir toute la liste/stats :
      // await loadEvents();

      // reset inputs
      document.getElementById('manualCredits').value = '';
      document.getElementById('manualPaymentId').value = '';

    } catch (e) {
      console.error(e);
      msg.textContent = '‚ùå Erreur r√©seau.';
    }
  });
}

// Rafra√Æchir le compteur "Cr√©dits participants disponibles"
async function refreshCredits() {
  try {
    const res = await fetch('/api/license/credits');
    const data = await res.json();
    const el = document.getElementById('participantCredits');
    if (el && typeof data.remaining_participant_credits === 'number') {
      el.textContent = data.remaining_participant_credits;
    }
  } catch (e) {
    console.warn('refreshCredits() a √©chou√©:', e);
  }
}

// ‚úÖ Charger √©v√©nements et stats
async function loadEvents() {
  try {
    const res = await fetchWithToken("/admin/events/list", {
      method: "POST",
      body: new URLSearchParams()
    });

    if (!res.ok) {
      throw new Error(`HTTP ${res.status} ${res.statusText}`);
    }

    let data;
    try {
      data = await res.json();
    } catch (e) {
      throw new Error("R√©ponse backend non-JSON");
    }

    console.log("üì¶ /admin/events/list ‚Üí", data);

    if (!data || data.success === false) {
      const msg = data?.message || data?.error || "Backend a renvoy√© success:false";
      throw new Error(msg);
    }

    const events = Array.isArray(data.events) ? data.events : [];

    // --- KPIs ---
    document.getElementById("totalEvents").textContent    = events.length;
    document.getElementById("activeEvents").textContent   = events.filter(e => !!e.is_active).length;
    document.getElementById("inactiveEvents").textContent = events.filter(e => !e.is_active).length;
    document.getElementById("participantCredits").textContent = data.participant_credits ?? 0;

    // --- Table ---
    const tbody = document.querySelector("#eventsTable tbody");
    tbody.innerHTML = "";

    const safe   = v => (v ?? "");
    const asText = v => String(v ?? "");

    events.forEach(ev => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${safe(ev.title)}</td>
        <td>${safe(ev.description)}</td>
        <td>${safe(ev.date)}</td>
        <td>${safe(ev.location)}</td>
        <td>${ev.price != null ? asText(ev.price) + " ‚Ç¨" : "‚Äî"}</td>
        <td>${ev.max_participants ?? "‚àû"}</td>

        <td>
          <b>Login :</b> ${safe(ev.checkin_login) || "‚Äî"}<br>
          <b>Pass :</b> <span class="pass" id="pass-${ev.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          <button class="btn-showpass" data-id="${ev.id}">üëÅÔ∏è</button>
        </td>

        <td>${safe(ev.checkin_login) || "‚Äî"}</td>

        <td>
          ${ev.image_url
            ? `<img src="${safe(ev.image_url)}" style="max-height:50px;border-radius:6px;">`
            : "‚Äî"}
        </td>

        <td>
          <a href="${safe(ev.public_url) || ("/static/event.html?id=" + ev.id)}" target="_blank" rel="noopener">
            <button class="action-btn link-btn">üîó Voir</button>
          </a>
        </td>

        <td>
          <button class="btn btn-primary btn-edit"  data-id="${ev.id}">‚úèÔ∏è Modifier</button>
          <button class="btn btn-danger  btn-del"   data-id="${ev.id}">üóëÔ∏è Supprimer</button>
          <button class="btn btn-warning btn-toggle" data-id="${ev.id}">
            ${ev.is_active ? "‚è∏Ô∏è D√©sactiver" : "‚ñ∂ Activer"}
          </button>
        </td>
      `;
      tbody.appendChild(row);

      // branchements sans inline JS
      row.querySelector(".btn-edit")   ?.addEventListener("click", () => openEditModal(ev.id));
      row.querySelector(".btn-del")    ?.addEventListener("click", () => deleteEvent(ev.id));
      row.querySelector(".btn-toggle") ?.addEventListener("click", () => toggleEvent(ev.id));
      row.querySelector(".btn-showpass")?.addEventListener("click", () => {
        const el = document.getElementById("pass-" + ev.id);
        if (!el) return;
        const real = ev.checkin_password ?? "";
        el.textContent = el.textContent.includes("‚Ä¢") ? real : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      });
    });

  } catch (err) {
    console.error("loadEvents() ‚Üí", err);
    alert("Erreur √©v√©nements : " + err.message);
  }
}

// ‚úÖ Charger les inscriptions pay√©es
async function loadPaidRegistrations() {
  const res = await fetchWithToken("/admin/paid-registrations", {
    method: "POST",
    body: new URLSearchParams()
  });
  const data = await res.json();
  if (!data.success) {
    alert(data.error || "Erreur de chargement");
    return;
  }

  const tbody = document.getElementById("registrationsTable");
  tbody.innerHTML = "";
  data.registrations.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.nom}</td>
      <td>${r.prenom}</td>
      <td>${r.email}</td>
      <td>${r.evenement}</td>
      <td>${r.montant} ‚Ç¨</td>
      <td>${r.date}</td>
    `;
    tbody.appendChild(row);
  });
}

// ‚úÖ Export CSV
async function exportCSV() {
  const response = await fetchWithToken("/admin/paid-registrations/csv", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams()
  });

  if (!response.ok) {
    alert("Erreur lors de l‚Äôexport CSV");
    return;
  }

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "inscriptions.csv";
  a.click();

  window.URL.revokeObjectURL(url);
}

// ‚úÖ Gestion √©dition / suppression
function openEditModal(id) {
  fetch(`/api/event/${id}`)
    .then(r => r.json())
    .then(data => {
      const ev = data.event || data;

      document.getElementById("edit_id").value = ev.id;
      document.getElementById("edit_title").value = ev.title || "";
      document.getElementById("edit_description").value = ev.description || "";
      document.getElementById("edit_date").value = ev.date || "";
      document.getElementById("edit_location").value = ev.location || "";
      document.getElementById("edit_price").value = ev.price || 0;
      document.getElementById("edit_max_participants").value = ev.max_participants || 100;
      document.getElementById("edit_checkin_login").value = ev.checkin_login || "";
      document.getElementById("edit_checkin_password").value = ev.checkin_password || "";

      document.getElementById("editModal").style.display = "flex";
    })
    .catch(err => {
      alert("‚ùå Impossible de charger l‚Äô√©v√©nement : " + err.message);
    });
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}
document.getElementById("cancelEditBtn").addEventListener("click", closeEditModal);


async function deleteEvent(id) {
  if (!confirm("Supprimer l‚Äô√©v√©nement ?")) return;
  const form = new URLSearchParams();
  form.append("event_id", id);

  const res = await fetchWithToken("/admin/events/delete", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur suppression : " + (data.error || ""));
}


async function toggleEvent(id) {
  const form = new URLSearchParams();
  form.append("event_id", id);

  const res = await fetchWithToken("/admin/events/toggle", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (data.success) loadEvents(); else alert("Erreur activation/d√©sactivation : " + (data.error || ""));
}

// ========================
// Navigation entre sections
// ========================
function showSection(id) {
  // Masquer toutes les sections
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));

  // Afficher uniquement la section choisie
  document.getElementById(id).classList.add("active");

  // R√©initialiser l'√©tat des boutons
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));

  // Activer le bouton correspondant
  if (id === "events") eventsBtn.classList.add("active");
  if (id === "paypalConfig") paypalConfigBtn.classList.add("active");
  if (id === "logs") logsBtn.classList.add("active");
  if (id === "buyCredits") buyCreditsBtn.classList.add("active");
  if (id === "paidRegistrations") paidRegistrationsBtn.classList.add("active");
}

// ‚ö° Brancher les boutons
eventsBtn.addEventListener("click", () => showSection("events"));
paypalConfigBtn.addEventListener("click", () => { showSection("paypalConfig"); loadPaypalStatus(); });
logsBtn.addEventListener("click", () => { showSection("logs"); loadLogs(); });
buyCreditsBtn.addEventListener("click", () => { showSection("buyCredits"); loadConfig(); setupManualCreditAdder(); refreshCredits(); });
paidRegistrationsBtn.addEventListener("click", () => { 
  showSection("paidRegistrations"); 
  loadPaidRegistrations(); 
});

// ========================
// V√©rifier statut PayPal
// ========================
async function loadPaypalStatus() {

  const res = await fetchWithToken("/admin/paypal/status", { method: "POST", body: new URLSearchParams() });
  const data = await res.json();

  const statusEl = document.getElementById("paypalStatus");
  const deleteBtn = document.getElementById("deletePaypalBtn");

  if (data.success && data.configured) {
    statusEl.innerHTML = `‚úÖ Compte PayPal configur√©<br><small>Client ID : ${data.client_id.substring(0,8)}... </small>`;
    statusEl.style.color = "green";
    deleteBtn.style.display = "inline-block";
  } else {
    statusEl.innerHTML = "‚ùå Aucun compte PayPal configur√©";
    statusEl.style.color = "red";
    deleteBtn.style.display = "none";
  }
}

// ========================
// Sauvegarde des identifiants PayPal
// ========================
document.getElementById("paypalForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new URLSearchParams();
  form.append("client_id", document.getElementById("paypal_client_id").value);
  form.append("secret", document.getElementById("paypal_secret").value);

  const res = await fetchWithToken("/admin/paypal/set", { method: "POST", body: form });
  const data = await res.json();

  if (data.success) {
    alert("‚úÖ Compte PayPal enregistr√© avec succ√®s !");
    document.getElementById("paypalForm").reset();
    loadPaypalStatus();
  } else {
    alert("‚ùå Erreur : " + (data.error || "Impossible d‚Äôenregistrer"));
  }
});


// ‚úÖ Sauvegarde modification (avec upload image)
document.getElementById("editEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const editForm = new FormData();
  editForm.append("event_id", document.getElementById("edit_id").value);
  editForm.append("title", document.getElementById("edit_title").value);
  editForm.append("description", document.getElementById("edit_description").value);
  editForm.append("date", document.getElementById("edit_date").value);
  editForm.append("location", document.getElementById("edit_location").value);
  editForm.append("price", document.getElementById("edit_price").value);
  editForm.append("max_participants", document.getElementById("edit_max_participants").value);
  editForm.append("checkin_login", document.getElementById("edit_checkin_login").value);
  editForm.append("checkin_password", document.getElementById("edit_checkin_password").value);

  // ‚úÖ Ajout de l‚Äôimage si un nouveau fichier est choisi
  const editImageFile = document.getElementById("edit_image").files[0];
  if (editImageFile) {
    editForm.append("image", editImageFile);
  }

  const res = await fetchWithToken("/admin/events/update", {
    method: "POST",
    body: editForm
  });
  const data = await res.json();
  if (data.success) {
    alert("‚úÖ √âv√©nement modifi√©");
    document.getElementById("editModal").style.display = "none";
    loadEvents();
  } else {
    alert("‚ùå Erreur modification : " + (data.error || "")); 
  }
});

// ========================
// Suppression PayPal s√©curis√©e
// ========================
const modal = document.getElementById("deletePaypalModal");
deletePaypalBtn.addEventListener("click", () => modal.style.display = "flex");
cancelDeleteBtn.addEventListener("click", () => { 
  modal.style.display = "none"; 
  document.getElementById("confirmPassword").value = ""; 
});

confirmDeleteBtn.addEventListener("click", async () => {
  const password = document.getElementById("confirmPassword").value;
  if (!password) return alert("‚ö†Ô∏è Merci de saisir ton mot de passe");

  const form = new URLSearchParams();
  form.append("password", password);

  const res = await fetchWithToken("/admin/paypal/delete", { method: "POST", body: form });
  const data = await res.json();

  if (data.success) {
    alert("‚úÖ " + data.message);
    loadPaypalStatus();
    modal.style.display = "none";
    document.getElementById("confirmPassword").value = "";
  } else {
    alert("‚ùå Erreur : " + (data.error || ""));
  }
});

// ========================
// Charger les logs admin
// ========================
async function loadLogs() {

  const res = await fetchWithToken("/admin/logs", { method: "POST", body: new URLSearchParams() });
  const data = await res.json();

  const tbody = document.querySelector("#logsTable tbody");
  tbody.innerHTML = "";

  if (data.success) {
    if (data.logs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3">Aucune action enregistr√©e</td></tr>`;
      return;
    }

data.logs.forEach(log => {
  const row = document.createElement("tr");

  let color = "#333"; // par d√©faut noir
  let icon = "‚ÑπÔ∏è";

  // üö´ Si c‚Äôest un refus webhook ‚Üí rouge
  if (log.action.includes("WEBHOOK_REFUSED")) {
    color = "red";
    icon = "üö´";
  }
  // ‚ö†Ô∏è Si c‚Äôest une suppression sensible (PayPal par ex.)
  else if (log.action.includes("DELETE_PAYPAL")) {
    color = "orange";
    icon = "‚ö†Ô∏è";
  }

  row.innerHTML = `
    <td><b style="color:${color}">${icon} ${log.action}</b></td>
    <td>${log.details || ""}</td>
    <td>${log.date}</td>
  `;
  tbody.appendChild(row);
});

  } else {
    alert("‚ùå Erreur chargement logs : " + (data.error || ""));
  }
}

// ‚úÖ Cr√©ation d‚Äôun nouvel √©v√©nement
document.getElementById("addEventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = new FormData();
  form.append("title", document.getElementById("title").value);
  form.append("description", document.getElementById("description").value);
  form.append("date", document.getElementById("date").value);
  form.append("location", document.getElementById("location").value);
  form.append("price", document.getElementById("price").value);
  form.append("max_participants", document.getElementById("max_participants").value);
  form.append("checkin_login", document.getElementById("checkin_login").value);
  form.append("checkin_password", document.getElementById("checkin_password").value);

  // ‚úÖ Ajout de l'image si un fichier est choisi
  const imageFile = document.getElementById("image").files[0];
  if (imageFile) {
    form.append("image", imageFile);
  }

  const res = await fetchWithToken("/admin/events", {
    method: "POST",
    body: form
  });
  const data = await res.json();

  if (data.success) {
    alert("‚úÖ √âv√©nement cr√©√© !");
    document.getElementById("addEventForm").reset();
    loadEvents(); // rafra√Æchit la liste et les stats
  } else {
    alert("‚ùå Erreur cr√©ation : " + (data.error || "Impossible de cr√©er l‚Äô√©v√©nement"));
  }
});

// ========================
// ‚è∞ D√©connexion auto apr√®s 15 min d‚Äôinactivit√©
// ========================
let inactivityTimer;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    localStorage.removeItem("admin_token");

    // ‚ûï Stocker la raison
    sessionStorage.setItem("logoutReason", "Vous avez √©t√© d√©connect√© pour cause d'inactivit√©.");

    // Redirection
    window.location.href = "/static/login.html";
  }, 900000); // en ms = 15 min
}

["mousemove", "keydown", "click", "scroll"].forEach(evt => {
  window.addEventListener(evt, resetInactivityTimer);
});
resetInactivityTimer();

</script>
<script>
function renderPayPalButton() {
  if (!window.paypal) {
    console.error("SDK PayPal non charg√© !");
    return;
  }

  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: selectedPack ? selectedPack.price : '149.00' // üí∂ montant dynamique ou valeur par d√©faut
          }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        console.log("‚úÖ Paiement valid√© :", details);
        // Redirection vers page succ√®s
        window.location.href = "/static/success.html?orderId=" + data.orderID;
      });
    },
    onCancel: function (data) {
      window.location.href = "/static/cancel.html";
    },
    onError: function (err) {
      console.error("‚ùå Erreur PayPal :", err);
      window.location.href = "/static/error.html";
    }
  }).render('#paypal-button-container');
}

// ‚ö° Attendre que le SDK soit charg√© avant de lancer le bouton
const checkPaypal = setInterval(() => {
  if (window.paypal) {
    clearInterval(checkPaypal);
    renderPayPalButton();
  }
}, 500);
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  loadEvents();
  refreshCredits();
  loadUserInfo();
});

</script>


</body>
</html>
